package com.rd.client.view.tms;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import com.google.gwt.user.client.rpc.AsyncCallback;
import com.rd.client.action.tms.dispatch.AddShpmNoAction;
import com.rd.client.action.tms.dispatch.CancelJourneySplitAction;
import com.rd.client.action.tms.dispatch.CancelSplitAction;
import com.rd.client.action.tms.dispatch.ChangedQntyAction;
import com.rd.client.action.tms.dispatch.ChangedTotalQntyAction;
import com.rd.client.action.tms.dispatch.DeleteLoadNoAction;
import com.rd.client.action.tms.dispatch.DispatchPrintAction;
import com.rd.client.action.tms.dispatch.ExportShpmItemAction;
import com.rd.client.action.tms.dispatch.LoadCancelAuditAction;
import com.rd.client.action.tms.dispatch.LoadCancelSendAction;
import com.rd.client.action.tms.dispatch.LoadDispatchAuditAction;
import com.rd.client.action.tms.dispatch.LoadSendConfirmAction;
import com.rd.client.action.tms.dispatch.MakeLoadNoAction;
import com.rd.client.action.tms.dispatch.QueryUnloadTableAction;
import com.rd.client.action.tms.dispatch.QueryUnshpmTableAction;
import com.rd.client.action.tms.dispatch.RemoveShpmNoAction;
import com.rd.client.action.tms.dispatch.SaveLoadNoAction;
import com.rd.client.action.tms.dispatch.ShpmCancelSendAction;
import com.rd.client.action.tms.dispatch.ShpmSaveAction;
import com.rd.client.action.tms.dispatch.ShpmSendConfirmAction;
import com.rd.client.action.tms.dispatch.SplitActionWin;
import com.rd.client.action.tms.dispatch.UnShpmPrintAction;
import com.rd.client.action.tms.dispatch.UnShpmSaveAction;
import com.rd.client.common.action.CancelAction;
import com.rd.client.common.action.ExportAction;
import com.rd.client.common.obj.FormUtil;
import com.rd.client.common.obj.LoginCache;
import com.rd.client.common.obj.SysParam;
import com.rd.client.common.util.ColorUtil;
import com.rd.client.common.util.MSGUtil;
import com.rd.client.common.util.ObjUtil;
import com.rd.client.common.util.StaticRef;
import com.rd.client.common.util.TrsPrivRef;
import com.rd.client.common.util.Util;
import com.rd.client.common.widgets.SGButtonItem;
import com.rd.client.common.widgets.SGCheck;
import com.rd.client.common.widgets.SGCombo;
import com.rd.client.common.widgets.SGDateTime;
import com.rd.client.common.widgets.SGForm;
import com.rd.client.common.widgets.SGPage;
import com.rd.client.common.widgets.SGPanel;
import com.rd.client.common.widgets.SGTable;
import com.rd.client.common.widgets.SGText;
import com.rd.client.ds.base.HaulingCapacityManagerDS;
import com.rd.client.ds.base.VCAreaDS;
import com.rd.client.ds.tms.BillPayDetailDS;
import com.rd.client.ds.tms.BillSettlePayDS;
import com.rd.client.ds.tms.LoadDS;
import com.rd.client.ds.tms.LoadShpmDS;
import com.rd.client.ds.tms.ShpmDS;
import com.rd.client.ds.tms.ShpmDetailDS;
import com.rd.client.ds.tms.TansActLogDS;
import com.rd.client.win.SearchWin;
import com.rd.client.win.VehicleWin;
import com.smartgwt.client.core.KeyIdentifier;
import com.smartgwt.client.data.Criteria;
import com.smartgwt.client.data.DSCallback;
import com.smartgwt.client.data.DSRequest;
import com.smartgwt.client.data.DSResponse;
import com.smartgwt.client.data.DataSource;
import com.smartgwt.client.data.Record;
import com.smartgwt.client.types.Alignment;
import com.smartgwt.client.types.Autofit;
import com.smartgwt.client.types.ListGridEditEvent;
import com.smartgwt.client.types.RecordSummaryFunctionType;
import com.smartgwt.client.types.SelectionAppearance;
import com.smartgwt.client.types.SummaryFunctionType;
import com.smartgwt.client.types.TextMatchStyle;
import com.smartgwt.client.types.TitleOrientation;
import com.smartgwt.client.util.SC;
import com.smartgwt.client.widgets.Canvas;
import com.smartgwt.client.widgets.IButton;
import com.smartgwt.client.widgets.Window;
import com.smartgwt.client.widgets.events.ClickEvent;
import com.smartgwt.client.widgets.events.ClickHandler;
import com.smartgwt.client.widgets.events.DoubleClickEvent;
import com.smartgwt.client.widgets.events.DoubleClickHandler;
import com.smartgwt.client.widgets.events.ShowContextMenuEvent;
import com.smartgwt.client.widgets.events.ShowContextMenuHandler;
import com.smartgwt.client.widgets.form.DynamicForm;
import com.smartgwt.client.widgets.form.fields.ComboBoxItem;
import com.smartgwt.client.widgets.form.fields.FormItemIcon;
import com.smartgwt.client.widgets.form.fields.TextItem;
import com.smartgwt.client.widgets.form.fields.events.FormItemClickHandler;
import com.smartgwt.client.widgets.form.fields.events.FormItemIconClickEvent;
import com.smartgwt.client.widgets.grid.ListGrid;
import com.smartgwt.client.widgets.grid.ListGridField;
import com.smartgwt.client.widgets.grid.ListGridRecord;
import com.smartgwt.client.widgets.grid.events.EditorExitEvent;
import com.smartgwt.client.widgets.grid.events.EditorExitHandler;
import com.smartgwt.client.widgets.grid.events.RecordClickEvent;
import com.smartgwt.client.widgets.grid.events.RecordClickHandler;
import com.smartgwt.client.widgets.grid.events.SelectionChangedHandler;
import com.smartgwt.client.widgets.grid.events.SelectionEvent;
import com.smartgwt.client.widgets.layout.SectionStack;
import com.smartgwt.client.widgets.layout.SectionStackSection;
import com.smartgwt.client.widgets.layout.VLayout;
import com.smartgwt.client.widgets.layout.VStack;
import com.smartgwt.client.widgets.menu.Menu;
import com.smartgwt.client.widgets.menu.MenuItem;
import com.smartgwt.client.widgets.menu.MenuItemSeparator;
import com.smartgwt.client.widgets.menu.events.MenuItemClickEvent;
import com.smartgwt.client.widgets.tab.Tab;
import com.smartgwt.client.widgets.tab.TabSet;
import com.smartgwt.client.widgets.tab.events.TabSelectedEvent;
import com.smartgwt.client.widgets.tab.events.TabSelectedHandler;
import com.smartgwt.client.widgets.toolbar.ToolStrip;
/**
 * 运输管理-->调度配载
 * @author yuanlei
 */
public class DispatchView extends SGForm{
    
	private DataSource ds;
	private DataSource loadDS;            //调度单数据源
	private DataSource shpmDS;            //已调作业单数据源
	private DataSource unshpmDS;          //待调作业单数据源
	private DataSource unshmplstDS;       //待调作业单明细数据源
	private DataSource billDS;
	private DataSource billItemDS;
	private DataSource logDS;             //业务日志数据源
	private SectionStack downSectionStack;  //左边按单调度SectionStack布局
	private SectionStack topSectionStack; //右边SectionStack布局
	private SectionStack topSectionStack2;  //
	private Window searchWin;
	private Window shipwin;
	private Window veWin;
	private Window shpmWin;
	private Window transTrackWin;
	private Window dispLoadWin;
	private Window unDispLoadWin;
	private SGPanel searchForm;
	private SGPanel chooseForm;
	private SGPanel veForm;
	public SGTable unshpmTable;     //待调作业单表
	public SGTable shpmTable;       //已调作业单表
	private SGTable unshpmlstTable;  //待调作业单明细表
	private SGTable loadTable;       //调度单表
	private SGTable logTable;       //业务日志
	private SGTable feeTable;
	private ListGrid feeitemTable;
	public DynamicForm sumForm;     //汇总FORM
	public DynamicForm pageForm;    //待调分页FORM
	public DynamicForm loadPageForm;    //调度单分页FORM
	private DispatchSubForm subView; //调度配载子页面
	
	public ListGridRecord[] unshpmlstRec;   //待调订单明细的初始值
	private int[] selectRows; //待调订单选中的值
	private int[] selectdetailRows;  //待调订单明细
	public QueryUnshpmTableAction qryUnshpmTableAction;
	public QueryUnloadTableAction qryUnloadTableAction;
	
	private String canModify;   //是否可修改调度单的毛重、体积、净重和货值
	private String canVehInput; //车辆信息是否允许输入
	private IButton shpmButton;
	private IButton saveButton;
	private IButton delButton;
	private IButton canButton;
	private IButton confirmButton;
	private IButton cansendButton;
	
	private IButton searchButton;
	
	private Record selRecord;   //调度单选中的记录
	private HashMap<String,IButton> sendMap;
	//private ListGridRecord selUnshpmRecord;  //待调作业单选中的记录
	//private ListGridField PLATE_NO;
	
	private ArrayList<ListGridField> suplrLst;
	private ArrayList<ListGridField> vehTypeLst;
	private ArrayList<ListGridField> areaLst;
 	
	public DispatchView(String id) {
		super(id);
	}

	public Canvas getViewPanel() {
		
		suplrLst = new ArrayList<ListGridField>();
		vehTypeLst = new ArrayList<ListGridField>();
		areaLst = new ArrayList<ListGridField>();
		
		privObj = LoginCache.getUserPrivilege().get(getFUNCID());
		sendMap = new HashMap<String, IButton>();
		getSysParam();  //获取系统参数
		
		subView = new DispatchSubForm();
		
		loadDS = LoadDS.getInstance("V_LOAD_HEADER", "TRANS_LOAD_HEADER");
		unshpmDS = ShpmDS.getInstance("V_SHIPMENT_HEADER_1", "TRANS_SHIPMENT_HEADER");
		shpmDS = LoadShpmDS.getInstance("V_SHIPMENT_HEADER_LOAD", "TRANS_SHIPMENT_HEADER");
		unshmplstDS = ShpmDetailDS.getInstance("V_SHIPMENT_ITEM_SF", "TRANS_SHIPMENT_ITEM");
		billDS = BillSettlePayDS.getInstance("V_BILL_LOAD_PAY","TRANS_BILL_PAY");
		billItemDS = BillPayDetailDS.getInstance("V_BILL_SHPM_PAY","TRANS_BILL_PAY");
		logDS = TansActLogDS.getInstance("V_CUSTOMACT_LOG_DISPATCH","TRANS_TRANSACTION_LOG");
		ds=HaulingCapacityManagerDS.getInstall("V_BAS_VEHICLE", "BAS_VEHICLE");
		VLayout main =new VLayout();  //整体布局
		main.setWidth100();
		main.setHeight100();
		
		VStack stack =new VStack();  //主布局(包含待调作业单和调度单上下两个列表)
		stack.setHeight100();
		stack.setWidth100();
		
		//上半部分 --yuanlei
		final TabSet topTabSet = new TabSet(); //主布局stack上半部分（包含待调作业单页签）
		final TabSet downTabSet = new TabSet();
		topTabSet.setWidth100();
		topTabSet.setHeight("50%");
		unshpmTable=new SGTable(unshpmDS, "100%", "100%", false, true, false) {
			
        	//明细表
			protected Canvas getExpansionComponent(final ListGridRecord record) {    				  
                VLayout layout = new VLayout();              
  
                /*unshpmlstTable = new SGTable(unshmplstDS,"100%","50",false,true,false);
                unshpmlstTable.setCanEdit(true);
                unshpmlstTable.setAlign(Alignment.RIGHT);
                unshpmlstTable.setShowRowNumbers(false);
                unshpmlstTable.setAutoFitData(Autofit.VERTICAL);
                unshpmlstTable.setSelectionAppearance(SelectionAppearance.CHECKBOX);*/
                

                unshpmlstTable = new SGTable();
                unshpmlstTable.setDataSource(unshmplstDS);
                unshpmlstTable.setWidth("40%");
                unshpmlstTable.setHeight(46);
                unshpmlstTable.setCanEdit(true);
                unshpmlstTable.setAutoFitData(Autofit.VERTICAL);
                unshpmlstTable.setSelectionAppearance(SelectionAppearance.CHECKBOX);
               
                Criteria findValues = new Criteria();
                findValues.addCriteria("OP_FLAG", StaticRef.MOD_FLAG);
		        findValues.addCriteria("SHPM_NO", record.getAttributeAsString("SHPM_NO"));
		        	
		        //作业单明细列表
		        ListGridField SHPM_ROW = new ListGridField("SHPM_ROW",Util.TI18N.ORD_ROW(), 45);
		        SHPM_ROW.setCanEdit(false);
		        ListGridField SKU = new ListGridField("SKU",Util.TI18N.SKU(), 110);
		        SKU.setCanEdit(false);
        		ListGridField SKU_NAME = new ListGridField("SKU_NAME",Util.TI18N.SKU_NAME(), 110);
        		SKU_NAME.setCanEdit(false);
		        ListGridField TEMPERATURE1 = new ListGridField("TEMPERATURE1_NAME",Util.TI18N.TEMPERATURE(), 60);
		        TEMPERATURE1.setCanEdit(false); 
        		ListGridField QNTY = new ListGridField("QNTY",Util.TI18N.QNTY(),70);
        		QNTY.setAlign(Alignment.RIGHT);
        		QNTY.addEditorExitHandler(new ChangedQntyAction(unshpmlstTable, getView()));
        		ListGridField VOL = new ListGridField("VOL",Util.TI18N.VOL(),70);
        		VOL.setAlign(Alignment.RIGHT);
        		//VOL.addEditorExitHandler(new ChangedVolAction(unshpmlstTable, getView()));
        		ListGridField G_WGT = new ListGridField("G_WGT",Util.TI18N.G_WGT(),70);
        		G_WGT.setAlign(Alignment.RIGHT);
        		//G_WGT.addEditorExitHandler(new ChangedGrossWAction(unshpmlstTable, getView()));
        		ListGridField UOM = new ListGridField("UOM",Util.TI18N.UNIT(),70);
        		UOM.setCanEdit(false);
  
        		unshpmlstTable.setFields(SHPM_ROW, SKU, SKU_NAME, QNTY, G_WGT, VOL,UOM, TEMPERATURE1);
        		unshpmlstTable.fetchData(findValues, new DSCallback() {

					@Override
					public void execute(DSResponse response, Object rawData,
							DSRequest request) {
						unshpmlstRec = unshpmlstTable.getRecords();
					}
        			
        		});
        		unshpmlstTable.addRecordClickHandler(new RecordClickHandler() {

					@Override
					public void onRecordClick(RecordClickEvent event) {
						ListGridRecord[] records = unshpmlstTable.getSelection();
						selectdetailRows = new int[records.length];
						for(int i = 0; i < records.length; i++) {
							selectdetailRows[i] = unshpmlstTable.getRecordIndex(records[i]);
						}
					}
        			
        		});
        		/*unshpmlstTable.addEditorExitHandler(new EditorExitHandler() {

					@Override
					public void onEditorExit(EditorExitEvent event) {
						unshpmlstTable.selectRecords(selectdetailRows);
					}
        			
        		});*/
                layout.addMember(unshpmlstTable);
                layout.setLayoutLeftMargin(60);
                
                return layout;   
            } 
		};
		unshpmTable.setSelectionAppearance(SelectionAppearance.CHECKBOX);
		unshpmTable.setCanEdit(true); 
		unshpmTable.setEditEvent(ListGridEditEvent.DOUBLECLICK);
		unshpmTable.setCanExpandRecords(true);
		//unshpmTable.setShowGroupSummary(true); 
		createUnshpmField(unshpmTable);
		
		
		topSectionStack =new SectionStack();	  //unshpmTable分页的布局	
		SectionStackSection section=new SectionStackSection(Util.TI18N.UNDISPATCHORDER());
		section.setItems(unshpmTable);
		section.setExpanded(true);
		sumForm = subView.createSumLayout();   //创建汇总布局
		pageForm = new SGPage(unshpmTable, true).initPageBtn();
		section.setControls(subView.createTopBtn(topTabSet, downTabSet), sumForm, pageForm);
		
		//SectionStackSection section1=new SectionStackSection("");
		//section1.setItems(toolStrip);
		//section.setExpanded(true);
		//topSectionStack.addSection(section1);
		//topSectionStack.addMember(toolStrip);
		topSectionStack.addSection(section);
    	topSectionStack.setWidth100();
    	topSectionStack.setHeight100();
    	//topSectionStack.setShowExpandControls(true);
    	VLayout lay=new VLayout();
    	if(isPrivilege(TrsPrivRef.DISPATCH_P1)) {
    		
    		Tab unshpmTab = new Tab(Util.TI18N.UNLOADINFO());//页签名称1：待调度作业单
    		//cvs.addChild(topSectionStack);
			unshpmTab.setPane(lay);
			topTabSet.addTab(unshpmTab);
    	}
    	
    	SGTable carTable=new SGTable(ds, "100%", "100%", false, true, false);
    	carTable.setCanEdit(false);
    	createVeField(carTable);

    	topSectionStack2=new SectionStack();
    	SectionStackSection section2=new SectionStackSection("车辆调度");
		section2.setItems(carTable);
		section2.setExpanded(true);
		DynamicForm mainform1=new DynamicForm();
		DynamicForm pageForm2 = new SGPage(carTable, true).initPageBtn();
		section2.setControls(subView.createTopBtn(topTabSet, downTabSet),mainform1, pageForm2);
		topSectionStack2.addSection(section2);
    	topSectionStack2.setWidth100();
    	topSectionStack2.setHeight100();
    	
    	
    	VLayout lay1=new VLayout();
    	if(isPrivilege(TrsPrivRef.DISPATCH_P1_1)) {
    		
    		Tab unshpmTab1 = new Tab("车辆调度");            //页签名称2：车辆调度
			unshpmTab1.setPane(lay1);
			topTabSet.addTab(unshpmTab1);
    	}
    	//上半部分结束   --yuanlei
			
		//下半部分布局  --yuanlei
		downTabSet.setWidth100();
		downTabSet.setHeight("49%");	
		
		loadTable = new SGTable(loadDS, "100%", "100%", false, true, false) {
			
			//第二层表
			protected Canvas getExpansionComponent(final ListGridRecord record) {    
				  
                VLayout layout = new VLayout();              
  
                shpmTable = new SGTable();
                shpmTable.setDataSource(shpmDS);
                shpmTable.setWidth("90%");
                shpmTable.setHeight(50);
                shpmTable.setShowFilterEditor(false);
                shpmTable.setShowAllRecords(true);
                shpmTable.setAutoFetchData(false);
                shpmTable.setAlign(Alignment.RIGHT);
                shpmTable.setShowRowNumbers(true);
                shpmTable.setSelectionAppearance(SelectionAppearance.CHECKBOX);
                shpmTable.setAutoFitData(Autofit.VERTICAL);
                shpmTable.setCanDragRecordsOut(true);   
                shpmTable.setCanAcceptDroppedRecords(true);   
                shpmTable.setCanReorderRecords(true);   
                //shpmTable.setAlternateRecordStyles(true);      
                shpmTable.setAutoFetchTextMatchStyle(TextMatchStyle.EXACT);   
                shpmTable.initBindEvent();
               
                Criteria findValues = new Criteria();
                findValues.addCriteria("OP_FLAG", StaticRef.MOD_FLAG);
		        findValues.addCriteria("LOAD_NO", record.getAttributeAsString("LOAD_NO"));
		        findValues.addCriteria("ALL_FLAG","true");
		        
		        LinkedHashMap<String, String> listMap = LoginCache.getListConfig().get(StaticRef.V_SHIPMENT_HEADER_LOAD);
				createListField(shpmTable, listMap);
				
		        //作业单列表
//		        ListGridField UNLOAD_SEQ = shpmTable.getField("UNLOAD_SEQ");
//		        if(UNLOAD_SEQ != null) {
//		        	UNLOAD_SEQ.setCanEdit(true);
//		        }
//		        else {
//		        	MSGUtil.sayError("列表中必须配置" + Util.TI18N.UNLOAD_SEQ() + "!");
//		        }
				/*ListGridField TOT_QNTY_EACH = shpmTable.getField("TOT_QNTY_EACH");
				if(TOT_QNTY_EACH !=null){
					TOT_QNTY_EACH.setCanEdit(true);
				}*/
				
				
        		ListGridField DEPART_TIME = shpmTable.getField("DEPART_TIME");
        		if(DEPART_TIME != null) {
	        		DEPART_TIME.setCanEdit(true);
	        		DEPART_TIME.setTitle(ColorUtil.getBlueTitle(Util.TI18N.END_LOAD_TIME()));
	        		Util.initDateTime(shpmTable,DEPART_TIME);
        		}
        		else {
        			MSGUtil.sayError("列表中必须配置" + Util.TI18N.END_LOAD_TIME() + "!");
        		}
        		
        		/*ListGridField PLATE_NO = shpmTable.getField("PLATE_NO");
 		        if(PLATE_NO != null) {
 		        	PLATE_NO.setCanEdit(true);
 		        }
 		        else {
 		        	MSGUtil.sayError("列表中必须配置" + Util.TI18N.PLATE_NO() + "!");
 		        }*/
        		
        		
        		//shpmTable.fetchData(findValues);
        		shpmTable.fetchData(findValues, new DSCallback() {

					@Override
					public void execute(DSResponse response, Object rawData,
							DSRequest request) {
						Util.db_async.getPageInfo(new AsyncCallback<ArrayList<String>>() {

							@Override
							public void onFailure(Throwable caught) {
								// TODO Auto-generated method stub
								
							}

							@Override
							public void onSuccess(ArrayList<String> result) {
								if(result != null && result.size() > 2) {
									shpmTable.setProperty("WHERE", result.get(2));
								}
							}
						});
					}
					
				});
        		
        		final Menu load_menu = new Menu();   //调度单右键
        		load_menu.setWidth(140);
        		MenuItemSeparator itemSeparator =new MenuItemSeparator();
        		
        		if(isPrivilege(TrsPrivRef.DISPATCH_P2_28)) {                      //wangjun 2011-3-9
        			
	        	    if(isPrivilege(TrsPrivRef.DISPATCH_P2_17)) {
		        	    MenuItem removeItem = new MenuItem("移除作业单",StaticRef.ICON_DEL);
		        	    load_menu.addItem(removeItem);
		        	    removeItem.addClickHandler(new RemoveShpmNoAction(shpmTable, unshpmTable, loadTable));
	        	    }
	        	    /*if(isPrivilege(TrsPrivRef.DISPATCH_P2_32)) {
		        	    MenuItem removeItem = new MenuItem("踢单",StaticRef.ICON_DEL);
		        	    load_menu.addItem(removeItem);
		        	    //removeItem.addClickHandler(new RemoveUnloadAction(shpmTable, unshpmTable, loadTable));//原剔除未发货
		        	    removeItem.addClickHandler(new DelUnsendShpmAction(shpmTable, unshpmTable, loadTable));
	        	    }*/
//	        	    if(isPrivilege(TrsPrivRef.DISPATCH_P2_32)) {
//		        	    MenuItem removeItem = new MenuItem("移除明细",StaticRef.ICON_DEL);
//		        	    load_menu.addItem(removeItem);
//		        	    removeItem.addClickHandler(new com.smartgwt.client.widgets.menu.events.ClickHandler() {
//		        	    	
//							@Override
//							public void onClick(MenuItemClickEvent event) {
//								String shpm_no = shpmTable.getSelectedRecord().getAttribute("SHPM_NO");
//								//String custom_odr_no = shpmTable.getSelectedRecord().getAttribute("CUSTOM_ODR_NO");
//								String status = shpmTable.getSelectedRecord().getAttribute("STATUS_NAME"); 
//								if(!StaticRef.SHPM_DIPATCH_NAME.equals(status)){
//									SC.warn("作业单["+shpm_no+"]状态不允许拆分！");
//									return;
//								}
//								
//								if(shpmTable != null && shpmTable.getSelection().length > 0){
//									new SplitShpmItemWin(loadTable, unshpmTable, shpmTable, sumForm, pageForm).getViewPanel().show();
//									
//								} else {
//									SC.warn("未勾选作业单明细!");
//								}			
//							}
//					    });
//	        	    }
	        	    if(isPrivilege(TrsPrivRef.DISPATCH_P2_18)) {
	        	    	load_menu.addItem(itemSeparator);
		        	    MenuItem sendconfirmItem = new MenuItem(Util.BI18N.SENDCONFIRM(),StaticRef.ICON_CONFIRM);
		        	    load_menu.addItem(sendconfirmItem);
		        	    sendconfirmItem.addClickHandler(new ShpmSendConfirmAction(shpmTable, loadTable));
	        	    }
	        	    
	        	    if(isPrivilege(TrsPrivRef.DISPATCH_P2_19)) {
		        	    MenuItem cansendItem = new MenuItem(Util.BI18N.CANCELSEND(),StaticRef.ICON_CANCEL);
		        	    load_menu.addItem(cansendItem);
		        	    cansendItem.addClickHandler(new ShpmCancelSendAction(shpmTable, loadTable));
	        	    }
	        	    
	        	    if(isPrivilege(TrsPrivRef.DISPATCH_P2_20)) {
	        	    	load_menu.addItem(itemSeparator);
		        	    MenuItem saveItem = new MenuItem(Util.BI18N.SAVE(),StaticRef.ICON_SAVE);
		        	    load_menu.addItem(saveItem);
		        	    saveItem.addClickHandler(new ShpmSaveAction(shpmTable));
	        	    }
	        	    /*if(isPrivilege(TrsPrivRef.DISPATCH_P2_21)) {
		        	    MenuItem saveItem = new MenuItem(Util.BI18N.SPLITBYLDQNTY(),StaticRef.ICON_CONFIRM);
		        	    saveItem.setKeyTitle("Alt+T");
		        	    KeyIdentifier saveKey = new KeyIdentifier();
		        	    saveKey.setAltKey(true);
		        	    saveKey.setKeyName("T");
		        	    saveItem.setKeys(saveKey);
		        	    load_menu.addItem(saveItem);
		        	    saveItem.addClickHandler(new SplitByLoadQntyAction(shpmTable,loadTable, getView()));
	        	    }*/ 
	        	    if(true) {
	        	    	load_menu.addItem(itemSeparator);
		        	    MenuItem expItem = new MenuItem(Util.BI18N.EXPORT(),StaticRef.ICON_EXPORT);
		        	    load_menu.addItem(expItem);
		        	    expItem.addClickHandler(new ExportAction(shpmTable));
	        	    }
	        	    shpmTable.addShowContextMenuHandler(new ShowContextMenuHandler() {
	                    public void onShowContextMenu(ShowContextMenuEvent event) {
	                    	load_menu.showContextMenu();
	                        event.cancel();
	                    }
	                });
        		}
        	    
        		layout.addMember(shpmTable);
        		layout.setLayoutTopMargin(5);
                layout.setLayoutLeftMargin(35);
                
                return layout;   
            }   
		};
		createLoadField(loadTable);
		loadTable.setCanExpandRecords(true);
		loadTable.setShowGridSummary(true);
		loadTable.setShowFilterEditor(false);
		loadTable.setCanEdit(true);
		loadTable.setShowRowNumbers(true);       
		loadTable.setEditEvent(ListGridEditEvent.DOUBLECLICK);
		loadTable.initBindEvent();
		
		downSectionStack =new SectionStack();   //loadTable分页的布局	
		loadPageForm = new SGPage(loadTable, true).initPageBtn();
		SectionStackSection listItem=new SectionStackSection(Util.TI18N.LISTINFO());//
		listItem.setItems(loadTable);
		listItem.setExpanded(true);
		listItem.setControls(subView.createDownBtn(topTabSet, downTabSet), loadPageForm);
		downSectionStack.addSection(listItem);
		
		logTable = new SGTable(logDS,"100%", "100%");
		createTransLogField(logTable);
		logTable.setShowRowNumbers(true);
		logTable.setShowFilterEditor(false);
		logTable.setCanEdit(false);
		
		/*loadTable.addSelectionChangedHandler(new SelectionChangedHandler() {
			@Override
			public void onSelectionChanged(SelectionEvent event) {
				System.out.println("SelectChanged");
				if (event.getRecord() == null) {
					return;
				}
				loadTable.OP_FLAG = "M";
				itemRow = loadTable.getRecordIndex(event.getRecord());
			
				initSaveBtn();			
			}
		});*/
		downTabSet.addTabSelectedHandler(new TabSelectedHandler() {
			
			@Override
			public void onTabSelected(TabSelectedEvent event) {
				ListGridRecord record = loadTable.getSelectedRecord();
				if(record != null && ObjUtil.isNotNull(record.getAttribute("LOAD_NO"))) {
					Criteria criteria = new Criteria();
					criteria.addCriteria("OP_FLAG", "M");
					criteria.addCriteria("DOC_TYP", "SHPM_NO");
					if(event.getTabNum() == 2){
						criteria.addCriteria("DOC_NO", record.getAttribute("LOAD_NO"));
						logTable.fetchData(criteria);
					}
					else if(event.getTabNum() == 1) {
						criteria.addCriteria("LOAD_NO", record.getAttribute("LOAD_NO"));
						feeTable.fetchData(criteria);
					}
				}
			}
		});
	
		if(isPrivilege(TrsPrivRef.DISPATCH_P2)) {
			Tab tab1 = new Tab(Util.TI18N.LOADINFO());//页签名称1：调度信息
			tab1.setPane(downSectionStack);
			downTabSet.addTab(tab1);
		}
		if(isPrivilege(TrsPrivRef.DISPATCH_P3)) {
			createFeeInfo();
			Tab tab2 = new Tab(Util.TI18N.EXP_DETAIL());//页签名称2：费用明细
			tab2.setPane(feeTable);
			downTabSet.addTab(tab2);
		}
		if(isPrivilege(TrsPrivRef.DISPATCH_P4)) {
			Tab tab3 = new Tab(Util.TI18N.BUS_DIARY());//页签名称2：业务日志
			downTabSet.addTab(tab3);
			tab3.setPane(logTable);
		
		}
		ToolStrip toolStrip1 = new ToolStrip();	
		toolStrip1.setAlign(Alignment.RIGHT);
		createVeBtnWidget(toolStrip1);
        lay1.addMember(toolStrip1);
    	lay1.addMember(topSectionStack2);
    	
    
    	
    	ToolStrip toolStrip = new ToolStrip();
		toolStrip.setAlign(Alignment.RIGHT);
		createBtnWidget(toolStrip);
		lay.addMember(toolStrip);
        lay.addMember(topSectionStack);
		
		//下半部分布局结束 --yuanlei
		
		// 按钮布局
//		ToolStrip toolStrip = new ToolStrip();
//		toolStrip.setAlign(Alignment.RIGHT);
//		createBtnWidget(toolStrip);
		
		stack.addMember(topTabSet);
		stack.addMember(downTabSet);
	//	main.addMember(toolStrip);
		main.addMember(stack);
		unshpmTable.addSelectionChangedHandler(new SelectionChangedHandler() {

			@Override
			public void onSelectionChanged(SelectionEvent event) {
				ListGridRecord[] records = unshpmTable.getSelection();
				if(records != null && records.length > 0) {
					selectRows = new int[records.length];
					double vol = 0.0000, g_w = 0.0000, qnty = 0.0000;
					for(int i = 0; i < records.length; i++) {
						vol += Double.parseDouble(ObjUtil.ifObjNull(records[i].getAttribute("TOT_VOL"), "0").toString());
						g_w += Double.parseDouble(ObjUtil.ifObjNull(records[i].getAttribute("TOT_GROSS_W"), "0").toString());
						qnty += Double.parseDouble(ObjUtil.ifObjNull(records[i].getAttribute("TOT_QNTY"), "0").toString());

						selectRows[i] = unshpmTable.getRecordIndex(records[i]);
					}
					sumForm.setValue("CUR_COUNT", records.length);
					sumForm.setValue("CUR_VOL", vol);
					sumForm.setValue("CUR_GROSS_W", g_w);
					sumForm.setValue("CUR_QNTY", qnty);
					setButtonEnabled(TrsPrivRef.DISPATCH_P2_02, shpmButton, true);
				}
			}
			
		});
		/*unshpmTable.addRecordClickHandler(new RecordClickHandler() {

			@Override
			public void onRecordClick(RecordClickEvent event) {
				//selUnshpmRecord = unshpmTable.getSelectedRecord();
				ListGridRecord[] records = unshpmTable.getSelection();
				if(records != null && records.length > 0) {
					selectRows = new int[records.length];
					double vol = 0.0000, g_w = 0.0000, qnty = 0.0000;
					for(int i = 0; i < records.length; i++) {
						vol += Double.parseDouble(ObjUtil.ifObjNull(records[i].getAttribute("TOT_VOL"), "0").toString());
						g_w += Double.parseDouble(ObjUtil.ifObjNull(records[i].getAttribute("TOT_GROSS_W"), "0").toString());
						qnty += Double.parseDouble(ObjUtil.ifObjNull(records[i].getAttribute("TOT_QNTY"), "0").toString());

						selectRows[i] = unshpmTable.getRecordIndex(records[i]);
					}
					sumForm.setValue("CUR_COUNT", records.length);
					sumForm.setValue("CUR_VOL", vol);
					sumForm.setValue("CUR_GROSS_W", g_w);
					sumForm.setValue("CUR_QNTY", qnty);
					
				}
			}
			
		});*/
		unshpmTable.addEditorExitHandler(new EditorExitHandler() {
			@Override
			public void onEditorExit(EditorExitEvent event) {
				unshpmTable.selectRecords(selectRows);
			}
			
		});
		initVerify();
		addRightKey();   //待调作业单右键
		
		initCombo();
		
		//new LoadPrintWin("./user/wpsadmin/JMLoadmentPrint.pdf","", loadTable,shpmTable, true);
		//com.google.gwt.user.client.Window.open("../user/wpsadmin/JMLoadmentPrint.pdf", "", "");
		return main;
	}


	private void createLoadField(final SGTable groupTable) {
		boolean isDigitCanEdit = false;
		if(ObjUtil.ifNull(canModify,"N").equals("Y")) {
			isDigitCanEdit = true;
		}
		ListGridField LOAD_NO = new ListGridField("LOAD_NO",Util.TI18N.LOAD_NO(),90);//调度单编号
		LOAD_NO.setShowGridSummary(true);
		LOAD_NO.setSummaryFunction(SummaryFunctionType.COUNT);
		LOAD_NO.setCanEdit(false);
		ListGridField PLATE_NO = new ListGridField("PLATE_NO",ColorUtil.getRedTitle(Util.TI18N.PLATE_NO()),60);//车牌号
		ListGridField STATUS_NAME = new ListGridField("STATUS_NAME",Util.TI18N.STATUS(),50);//状态
		STATUS_NAME.setCanEdit(false);
		ListGridField DISPATCH_STAT_NAME = new ListGridField("DISPATCH_STAT_NAME", Util.TI18N.DISPATCH_STAT_NAME(), 60);  //配车状态
		DISPATCH_STAT_NAME.setCanEdit(false);
		
		ListGridField VEHICLE_TYP = new ListGridField("VEHICLE_TYP_ID",Util.TI18N.VEHICLE_TYP(),60);//车辆类型
		//Util.initComboValue(VEHICLE_TYP, "BAS_VEHICLE_TYPE", "ID", "VEHICLE_TYPE", " WHERE ENABLE_FLAG = 'Y'", " SHOW_SEQ ASC");  //车辆类型
		vehTypeLst.add(VEHICLE_TYP);
		
		ListGridField TRANS_SRVC_ID = new ListGridField("TRANS_SRVC_ID", ColorUtil.getRedTitle(Util.TI18N.TRANS_SRVC_ID()),70);
		Util.initTrsService(TRANS_SRVC_ID, "");
		
		ListGridField START_AREA_ID = new ListGridField("START_AREA_ID",Util.TI18N.AREA_NAME(),0);
		ListGridField START_AREA = new ListGridField("START_AREA_NAME",ColorUtil.getRedTitle(Util.TI18N.LOAD_AREA_NAME()),120);//起点区域
		START_AREA_ID.setCanEdit(false);
		START_AREA_ID.setHidden(true);
		initArea(loadTable,START_AREA,"START_AREA_ID", "START_AREA_NAME", "");
		areaLst.add(START_AREA);
		ListGridField END_AREA_ID = new ListGridField("END_AREA_ID",Util.TI18N.AREA_NAME(),0);
		ListGridField END_AREA = new ListGridField("END_AREA_NAME",ColorUtil.getRedTitle(Util.TI18N.END_AREA()),120);//终点区域
		END_AREA_ID.setCanEdit(false);
		END_AREA_ID.setHidden(true);
		initArea(loadTable,END_AREA, "END_AREA_ID", "END_AREA_NAME", "");
		areaLst.add(END_AREA);
		ListGridField DEPART_TIME = new ListGridField("DEPART_TIME", ColorUtil.getBlueTitle(Util.TI18N.END_LOAD_TIME()), 110);  //发运时间
		//Util.initListGridDateTime(DEPART_TIME);
		Util.initDateTime(loadTable,DEPART_TIME);
		
		ListGridField DONE_TIME = new ListGridField("DONE_TIME", ColorUtil.getBlueTitle("预计回场时间"), 110);  //发运时间
		//Util.initListGridDateTime(DEPART_TIME);
		Util.initDateTime(loadTable,DONE_TIME);
		
		ListGridField REMAIN_GROSS_W = new ListGridField("REMAIN_GROSS_W","余量",50);//余量
		REMAIN_GROSS_W.setCanEdit(false);
		
		final ListGridField UDF1 = new ListGridField("UDF1",Util.TI18N.LOAD_UDF21(),65);//随车特服
		UDF1.setCanEdit(true);
		
		ListGridField UDF2 = new ListGridField("UDF2", Util.TI18N.LOAD_UDF22(), 85);  //电话
		
		ListGridField EXEC_ORG_ID_NAME = new ListGridField("EXEC_ORG_ID_NAME", Util.TI18N.EXEC_ORG_ID_NAME(), 80);  //供应商
		EXEC_ORG_ID_NAME.setCanEdit(false);
		ListGridField SUPLR_NAME = new ListGridField("SUPLR_ID", ColorUtil.getRedTitle(Util.TI18N.SUPLR_NAME()), 70);  //供应商
		//Util.initOrgSupplier(SUPLR_NAME, "");
		suplrLst.add(SUPLR_NAME);
		ListGridField DRIVER1 = new ListGridField("DRIVER1", Util.TI18N.DRIVER1(), 50);  //司机
		ListGridField MOBILE1 = new ListGridField("MOBILE1", Util.TI18N.MOBILE(), 85);  //电话
		ListGridField TOT_QNTY = new ListGridField("TOT_QNTY","总数量",50);//总数量
		TOT_QNTY.setRecordSummaryFunction(RecordSummaryFunctionType.MULTIPLIER);   
		TOT_QNTY.setSummaryFunction(SummaryFunctionType.SUM);
		TOT_QNTY.setShowGroupSummary(true); 
		TOT_QNTY.setAlign(Alignment.RIGHT);
		TOT_QNTY.setCanEdit(isDigitCanEdit);
		if(isDigitCanEdit) {
			TOT_QNTY.addEditorExitHandler(new ChangedTotalQntyAction(loadTable, "TOT_QNTY", Util.TI18N.TOT_QNTY()));
		}
		ListGridField TOT_QNTY_EACH = new ListGridField("TOT_QNTY_EACH",Util.TI18N.R_EA(),50);//总数量
		TOT_QNTY_EACH.setRecordSummaryFunction(RecordSummaryFunctionType.MULTIPLIER);   
		TOT_QNTY_EACH.setSummaryFunction(SummaryFunctionType.SUM);
		TOT_QNTY_EACH.setShowGroupSummary(true); 
		TOT_QNTY_EACH.setAlign(Alignment.RIGHT);
		TOT_QNTY_EACH.setCanEdit(isDigitCanEdit);
		if(isDigitCanEdit) {
			TOT_QNTY_EACH.addEditorExitHandler(new ChangedTotalQntyAction(loadTable, "TOT_QNTY_EACH", Util.TI18N.R_EA()));
		}
		ListGridField TOT_GROSS_W = new ListGridField("TOT_GROSS_W",Util.TI18N.TOT_GROSS_W(),60);//总毛重
		TOT_GROSS_W.setRecordSummaryFunction(RecordSummaryFunctionType.MULTIPLIER);   
		TOT_GROSS_W.setSummaryFunction(SummaryFunctionType.SUM); 
		TOT_GROSS_W.setShowGroupSummary(true); 
		TOT_GROSS_W.setAlign(Alignment.RIGHT);
		TOT_GROSS_W.setCanEdit(isDigitCanEdit);
		if(isDigitCanEdit) {
			TOT_GROSS_W.addEditorExitHandler(new ChangedTotalQntyAction(loadTable, "TOT_GROSS_W", Util.TI18N.TOT_GROSS_W()));
		}
		ListGridField TOT_VOL = new ListGridField("TOT_VOL",Util.TI18N.TOT_VOL(),60);//总体积
		//TOT_VOL.setRecordSummaryFunction(RecordSummaryFunctionType.MULTIPLIER); 
		TOT_VOL.setSummaryFunction(SummaryFunctionType.SUM);
		TOT_VOL.setAlign(Alignment.RIGHT);
		TOT_VOL.setShowGroupSummary(true); 
		TOT_VOL.setCanEdit(isDigitCanEdit);
		if(isDigitCanEdit) {
			TOT_VOL.addEditorExitHandler(new ChangedTotalQntyAction(loadTable, "TOT_VOL", Util.TI18N.TOT_VOL()));
		}
		final ListGridField NOTES = new ListGridField("NOTES",Util.TI18N.NOTES(),65);//备注
		NOTES.setCanEdit(true);
		
		ListGridField VEH_SIGN=new ListGridField("VEH_SIGN","车标号",80);
		
		groupTable.setFields(LOAD_NO,STATUS_NAME, DISPATCH_STAT_NAME, TRANS_SRVC_ID, START_AREA_ID,START_AREA, END_AREA_ID, END_AREA, SUPLR_NAME, PLATE_NO,VEHICLE_TYP
				,DRIVER1, MOBILE1, REMAIN_GROSS_W,DEPART_TIME, DONE_TIME, UDF1,UDF2,VEH_SIGN,TOT_QNTY,TOT_QNTY_EACH,NOTES, TOT_VOL, TOT_GROSS_W,EXEC_ORG_ID_NAME);	
		
		if(ObjUtil.ifNull(canVehInput,"N").equals("N")) {
			FormItemIcon icon = new FormItemIcon();
			PLATE_NO.setIcons(icon);
			PLATE_NO.setShowSelectedIcon(true);
			icon.addFormItemClickHandler(new FormItemClickHandler() {
				
				@Override
				public void onFormItemClick(FormItemIconClickEvent event) {
					Util.db_async.getSingleRecord("TEMPERATURE1,TEMPERATURE2,TOT_GROSS_W", "TRANS_LOAD_HEADER", 
							" where LOAD_NO = '" + selRecord.getAttribute("LOAD_NO") + "'", null, new AsyncCallback<HashMap<String, String>>() {
								@Override
								public void onFailure(Throwable caught) {
									// TODO Auto-generated method stub		
								}

								@Override
								public void onSuccess(
										HashMap<String, String> result) {
									if(result != null && result.size() > 0) {
										HashMap<String,String> map = new HashMap<String,String>();
										String TEMPERATURE1 = ObjUtil.ifNull(result.get("TEMPERATURE1"),"");
										String TEMPERATURE2 = ObjUtil.ifNull(result.get("TEMPERATURE2"),"");
										String TOT_GROSS_W = result.get("TOT_GROSS_W");
										String tmp_attr = StaticRef.TMP_SINGLE;
										if (!TEMPERATURE1.equals(TEMPERATURE2)) {
											tmp_attr = StaticRef.TMP_DOUBLE;
										}
										map.put("TMP_ATTR", tmp_attr);
										map.put("REMAIN_GROSS_W",TOT_GROSS_W);
										map.put("AVAIL_FLAG",StaticRef.AVAIL_FLAG);
										new VehicleWin(groupTable,itemRow,"20%", "32%", map).getViewPanel();
									}
									else {
										new VehicleWin(groupTable,itemRow,"20%", "32%").getViewPanel();
									}
								}						
					});					
				}
			});
		}
		
		
		PLATE_NO.addEditorExitHandler(new EditorExitHandler() {

			@Override
			public void onEditorExit(EditorExitEvent event) {
				final int row = event.getRowNum();
				String plate_no = ObjUtil.ifObjNull(event.getNewValue(), "").toString();
				if(ObjUtil.isNotNull(plate_no)) {
					Util.db_async.getSingleRecord("PLATE_NO,VEHICLE_TYP_ID,DRIVER1_NAME,MOBILE1", "V_BAS_VEHICLE"
							, " where ENABLE_FLAG = 'Y' and PLATE_NO = '" + plate_no + "'", null, new AsyncCallback<HashMap<String, String>>() {

								@Override
								public void onFailure(Throwable caught) {					
								}

								@Override
								public void onSuccess(HashMap<String, String> result) {
									if(result != null && result.size() > 0) {
										loadTable.setEditValue(row, "PLATE_NO", ObjUtil.ifObjNull(result.get("PLATE_NO"), "").toString());
										loadTable.setEditValue(row, "VEHICLE_TYP_ID", ObjUtil.ifObjNull(result.get("VEHICLE_TYP_ID"), "").toString());
										loadTable.setEditValue(row, "DRIVER1", ObjUtil.ifObjNull(result.get("DRIVER1_NAME"), "").toString());
										loadTable.setEditValue(row, "MOBILE1", ObjUtil.ifObjNull(result.get("MOBILE1"), "").toString());
									}
									else {
										loadTable.setEditValue(row, "VEHICLE_TYP_ID", "");
										loadTable.setEditValue(row, "DRIVER1", "");
										loadTable.setEditValue(row, "MOBILE1", "");
									}
								}
						
					});
				}
			}
			
		});
		
		/*loadTable.addSelectionChangedHandler(new SelectionChangedHandler() {
			
			public void onSelectionChanged(SelectionEvent event) {
				enableOrDisables(save_map, false);
				selRecord = event.getRecord();
				if(selRecord != null) {
					if(selRecord.getAttribute("STATUS_NAME").equals(StaticRef.TRANS_CREATE_NAME)) {
						enableOrDisables(del_map, true);
						setSendBtnStatus(true);
					}
					else if(selRecord.getAttribute("STATUS_NAME").equals(StaticRef.TRANS_DEPART_NAME)){
						enableOrDisables(del_map, false);
						setSendBtnStatus(false);
					}
					else {
						enableOrDisables(del_map, false);
						setButtonEnabled(TrsPrivRef.DISPATCH_P2_06, confirmButton, false);
						setButtonEnabled(TrsPrivRef.DISPATCH_P2_07, cansendButton, false);
					}
				}
			}
		});*/
		loadTable.addRecordClickHandler(new RecordClickHandler() {

			@Override
			public void onRecordClick(RecordClickEvent event) {
				//enableOrDisables(save_map, false);
				selRecord = event.getRecord();
				loadTable.OP_FLAG = "M";
				itemRow = loadTable.getRecordIndex(selRecord);
			
				if(selRecord != null) {
					if(selRecord.getAttribute("STATUS_NAME").equals(StaticRef.TRANS_CREATE_NAME)) {
						enableOrDisables(del_map, true);
						enableOrDisables(save_map, false);
						setSendBtnStatus(true);
					}
					else if(selRecord.getAttribute("STATUS_NAME").equals(StaticRef.TRANS_DEPART_NAME)){
						enableOrDisables(del_map, false);
						enableOrDisables(save_map, false);
						setSendBtnStatus(false);
					}
					else {
						enableOrDisables(del_map, false);
						enableOrDisables(save_map, false);
						setButtonEnabled(TrsPrivRef.DISPATCH_P2_06, confirmButton, false);
						setButtonEnabled(TrsPrivRef.DISPATCH_P2_07, cansendButton, false);
					}
				}
			}
			
		});
		loadTable.addDoubleClickHandler(new DoubleClickHandler() {

			@Override
			public void onDoubleClick(DoubleClickEvent event) {
				
				if(selRecord != null && selRecord.getAttribute("STATUS_NAME").equals(StaticRef.TRANS_CREATE_NAME)) {
					
					if(selRecord.getAttribute("DISPATCH_STAT_NAME").equals(StaticRef.NO_DISPATCH_NAME)) {
//						loadTable.setCanEdit(true);
						loadTable.getField("START_AREA_NAME").setCanEdit(true);
						loadTable.getField("END_AREA_NAME").setCanEdit(true);
						loadTable.getField("TRANS_SRVC_ID").setCanEdit(false);
						loadTable.getField("SUPLR_ID").setCanEdit(true);
						loadTable.getField("PLATE_NO").setCanEdit(true);
						loadTable.getField("VEHICLE_TYP_ID").setCanEdit(true);
						loadTable.getField("DRIVER1").setCanEdit(true);
						loadTable.getField("MOBILE1").setCanEdit(true);
						NOTES.setCanEdit(true);
					}
					else {
						loadTable.setCanEdit(true);
						loadTable.getField("START_AREA_NAME").setCanEdit(false);
						loadTable.getField("END_AREA_NAME").setCanEdit(false);
						loadTable.getField("TRANS_SRVC_ID").setCanEdit(false);
						loadTable.getField("SUPLR_ID").setCanEdit(false);
						loadTable.getField("PLATE_NO").setCanEdit(false);
						loadTable.getField("VEHICLE_TYP_ID").setCanEdit(false);
						loadTable.getField("DRIVER1").setCanEdit(false);
						loadTable.getField("MOBILE1").setCanEdit(false);
						if(isPrivilege(TrsPrivRef.DISPATCH_P2_15)){
							NOTES.setCanEdit(true);
						}else{
							NOTES.setCanEdit(false);
						}
					}
					
					loadTable.getField("DEPART_TIME").setCanEdit(true);
					enableOrDisables(del_map, false);  //不能删除
					enableOrDisables(save_map, true);  //可以保存和取消
					//enableOrDisables(sendMap, true);   //可以发运确认
					setSendBtnStatus(true);
				}
				else {
					loadTable.setCanEdit(true);
					loadTable.getField("DEPART_TIME").setCanEdit(true);
					enableOrDisables(del_map, false);
					setButtonEnabled(TrsPrivRef.DISPATCH_P2_03, saveButton, false);
					setButtonEnabled(TrsPrivRef.DISPATCH_P2_05, canButton, false);
					setButtonEnabled(TrsPrivRef.DISPATCH_P2_06, confirmButton, false);
					if(selRecord != null && selRecord.getAttribute("STATUS_NAME").equals(StaticRef.TRANS_DEPART_NAME)) {
						setButtonEnabled(TrsPrivRef.DISPATCH_P2_07, cansendButton, true);
					}
					else {
						setButtonEnabled(TrsPrivRef.DISPATCH_P2_07, cansendButton, false);
					}
				}
			}
			
		});
		/*loadTable.addEditorExitHandler(new EditorExitHandler() {

			@Override
			public void onEditorExit(EditorExitEvent event) {
				if(saveButton != null) {
					saveButton.fireEvent(new ClickEvent(saveButton.getJsObj()));
				}
			}
			
		});*/
		
	
		final Menu menu = new Menu();//主界面【调度单信息】页签：右键
	    menu.setWidth(140);
	    MenuItemSeparator itemSeparator =new MenuItemSeparator();
	    
	    MenuItem printItem = new MenuItem("打印调度单",StaticRef.ICON_PRINT);
	    printItem.addClickHandler(new DispatchPrintAction(loadTable));
		menu.addItem(printItem);
		MenuItem printItem2 = new MenuItem("打印调度单",StaticRef.ICON_PRINT);
	    printItem2.addClickHandler(new DispatchPrintAction(loadTable));
		menu.addItem(printItem2);
		Menu m = new Menu();
		MenuItem b2bPrintItem = new MenuItem("打印冷运专运调度单",StaticRef.ICON_PRINT);
		b2bPrintItem.addClickHandler(new com.smartgwt.client.widgets.menu.events.ClickHandler() {
			
			@Override
			public void onClick(MenuItemClickEvent event) {
				new DispatchPrintAction(loadTable, "b2bDispatch").onClick(event);
			}
		});
		MenuItem gxPrintItem = new MenuItem("打印干线调度单",StaticRef.ICON_PRINT);
		gxPrintItem.addClickHandler(new com.smartgwt.client.widgets.menu.events.ClickHandler() {
			
			@Override
			public void onClick(MenuItemClickEvent event) {
				new DispatchPrintAction(loadTable, "arteryDispatch").onClick(event);
			}
		});
		MenuItem psPrintItem = new MenuItem("打印零担派送调度单",StaticRef.ICON_PRINT);
		psPrintItem.addClickHandler(new com.smartgwt.client.widgets.menu.events.ClickHandler() {
			
			@Override
			public void onClick(MenuItemClickEvent event) {
				new DispatchPrintAction(loadTable, "sendDispatch").onClick(event);
			}
		});
//		MenuItem tfqdPrintItem = new MenuItem("打印提货清单",StaticRef.ICON_PRINT);
//		tfqdPrintItem.addClickHandler(new DispatchPrintAction(loadTable, "deliveryManifest"));
		MenuItem tfPrintItem = new MenuItem("打印零担提货调度单",StaticRef.ICON_PRINT);
		tfPrintItem.addClickHandler(new com.smartgwt.client.widgets.menu.events.ClickHandler() {
			
			@Override
			public void onClick(MenuItemClickEvent event) {
				new DispatchPrintAction(loadTable, "deliveryDispatch").onClick(event);
			}
		});
//		MenuItem b2cPrintItem = new MenuItem("打印B2C派送调度出库单",StaticRef.ICON_PRINT);
//		b2cPrintItem.addClickHandler(new DispatchPrintAction(loadTable, "b2cDispatch"));
//		MenuItem b2cRoutePrintItem = new MenuItem("打印B2C直送调度出库单",StaticRef.ICON_PRINT);
//		b2cRoutePrintItem.addClickHandler(new DispatchPrintAction(loadTable, "b2cRouteDispatch"));
		
		MenuItem b2cPrintItem = new MenuItem("打印冷运速配汇总出库单",StaticRef.ICON_PRINT);
		b2cPrintItem.addClickHandler(new com.smartgwt.client.widgets.menu.events.ClickHandler() {
			
			@Override
			public void onClick(MenuItemClickEvent event) {
				new DispatchPrintAction(loadTable, "b2cArtDispatch").onClick(event);
			}
		});
		MenuItem b2cPrintItem2 = new MenuItem("打印冷运速配明细出库单",StaticRef.ICON_PRINT);
		b2cPrintItem2.addClickHandler(new com.smartgwt.client.widgets.menu.events.ClickHandler() {
			
			@Override
			public void onClick(MenuItemClickEvent event) {
				new DispatchPrintAction(loadTable, "b2cDispatch").onClick(event);
			}
		});
		
		MenuItem shopPrintItem = new MenuItem("打印冷运速配调度出库单",StaticRef.ICON_PRINT);
		shopPrintItem.addClickHandler(new com.smartgwt.client.widgets.menu.events.ClickHandler() {
			
			@Override
			public void onClick(MenuItemClickEvent event) {
				new DispatchPrintAction(loadTable, "shopDispatch").onClick(event);
			}
		});
		
		//MenuItem newDispatch=new MenuItem("打印不干胶模板",StaticRef.ICON_PRINT);
		//newDispatch.addClickHandler(new DispatchPrintAction(loadTable,"newDispatch"));
		
		m.addItem(b2bPrintItem);
		m.addItem(gxPrintItem);
		m.addItem(psPrintItem);
//		m.addItem(tfqdPrintItem);
		m.addItem(tfPrintItem);
		m.addItem(b2cPrintItem);
		m.addItem(b2cPrintItem2);
		m.addItem(shopPrintItem);
		//m.addItem(newDispatch);
//		m.addItem(b2cRoutePrintItem);
		printItem2.setSubmenu(m);
	    
	    if(isPrivilege(TrsPrivRef.DISPATCH_P2_29)) {                                          //wangjun 2010-3-24
			 MenuItem shpmList = new MenuItem("相关作业单信息",StaticRef.ICON_NEW);  //相关作业单信息
		     menu.addItem(shpmList);
		     shpmList.addClickHandler(new com.smartgwt.client.widgets.menu.events.ClickHandler() {
				
				  @Override
				  public void onClick(MenuItemClickEvent event) {
					  ListGridRecord loadRec = loadTable.getSelectedRecord();
					  unDispLoadWin = new UnDispLoadWin(loadRec.getAttribute("LOAD_NO")).getViewPanel();
				  }
			 });
		}

	    if(isPrivilege(TrsPrivRef.DISPATCH_P2_11)) {
			 MenuItem skuList = new MenuItem(Util.BI18N.GOODS_INFO(),StaticRef.ICON_NEW);  //货品信息
		     menu.addItem(skuList);
		     skuList.addClickHandler(new com.smartgwt.client.widgets.menu.events.ClickHandler() {
				
				  @Override
				  public void onClick(MenuItemClickEvent event) {
					  ListGridRecord loadRec = loadTable.getSelectedRecord();
					  Criteria crit = loadTable.getCriteria();
				        if(crit != null && Util.iff(crit.getAttributeAsString("HISTORY_FLAG"),"false").equals("true")) {
				        	dispLoadWin = new DispLoadWin(getView(),loadRec.getAttribute("LOAD_NO"),"true").getViewPanel();
				        }
				        else {
				        	dispLoadWin = new DispLoadWin(getView(),loadRec.getAttribute("LOAD_NO")).getViewPanel();
				        }
				  }
			 });
		}
	    /*if(isPrivilege(TrsPrivRef.DISPATCH_P2_12)) {
	    	menu.addItem(itemSeparator);
			 MenuItem skuList = new MenuItem("路线预览",StaticRef.ICON_SEARCH);  //行车预览
		     menu.addItem(skuList);
		     skuList.addClickHandler(new ViewRouteAction(loadTable));
		    
		}*/
	    
	    /*if(isPrivilege(TrsPrivRef.DISPATCH_P2_13) || isPrivilege(TrsPrivRef.DISPATCH_P2_14)) {
		    if(isPrivilege(TrsPrivRef.DISPATCH_P2_13)) {
		    	menu.addItem(itemSeparator);
			    MenuItem skuList = new MenuItem(Util.BI18N.DISPATCH_CONFIRM(),StaticRef.ICON_CONFIRM); //配车确认
		        menu.addItem(skuList);
		        skuList.addClickHandler(new LoadDispatchConfirmAction(loadTable));
		    }
		    if(isPrivilege(TrsPrivRef.DISPATCH_P2_14)) {
			    MenuItem skuList = new MenuItem(Util.BI18N.CANCEL_DISPATCH(),StaticRef.ICON_CANCEL); //取消确认
		        menu.addItem(skuList);
		        skuList.addClickHandler(new LoadCancelConfirmAction(loadTable));
		       
			}
		   
	    }*/
	    
	    if(isPrivilege(TrsPrivRef.DISPATCH_P2_15) || isPrivilege(TrsPrivRef.DISPATCH_P2_16)) {
		    if(isPrivilege(TrsPrivRef.DISPATCH_P2_15)) {
		    	menu.addItem(itemSeparator);
				MenuItem skuList = new MenuItem(Util.BI18N.DISPATCH_AUDIT(),StaticRef.ICON_CONFIRM); //配车审核
			    menu.addItem(skuList);
			    skuList.addClickHandler(new LoadDispatchAuditAction(loadTable,check_map, getView()));
			}
		    if(isPrivilege(TrsPrivRef.DISPATCH_P2_16)) {
				MenuItem skuList = new MenuItem(Util.BI18N.CANCEL_AUDIT(),StaticRef.ICON_CANCEL);  //取消审核
			    menu.addItem(skuList);
			    skuList.addClickHandler(new LoadCancelAuditAction(loadTable));
			    
			}
		    
		    /*if(isPrivilege(TrsPrivRef.DISPATCH_P2_31)) {
		        MenuItem getBack = new MenuItem("打回",StaticRef.ICON_CANCEL);
		        menu.addItem(getBack); 
		        getBack.addClickHandler(new LoadGetBackAction(loadTable));
		    }*/   

	    }
	    
	    if(isPrivilege(TrsPrivRef.DISPATCH_P2_30)) {  //刷新  （调度刷新）
	    	menu.addItem(itemSeparator);
		    MenuItem refreshItem = new MenuItem(Util.BI18N.REFRESH(),StaticRef.ICON_REFRESH);
		    menu.addItem(refreshItem);
		    qryUnloadTableAction = new QueryUnloadTableAction(loadTable, pageForm);
		    refreshItem.addClickHandler(qryUnloadTableAction);
		    
	    }
	    
	    if(isPrivilege(TrsPrivRef.DISPATCH_P2_10)) {
			MenuItem expList = new MenuItem(Util.BI18N.EXPORT(),StaticRef.ICON_EXPORT);  //导出
		    menu.addItem(expList);
		    expList.addClickHandler(new ExportAction(loadTable));
	    } 

	    loadTable.addShowContextMenuHandler(new ShowContextMenuHandler() {
            public void onShowContextMenu(ShowContextMenuEvent event) {
            	menu.showContextMenu();
                event.cancel();
            }
        });
	    
	}
	
	/**
	 * 业务日志
	 * @author wangjun
	 * @param logTable
	 */
	private void createTransLogField(SGTable logTable) {

		ListGridField DOC_NO = new ListGridField("DOC_NO", Util.TI18N.SHPM_NO(),150);
		ListGridField OCCUR_TIME = new ListGridField("ADDTIME", Util.TI18N.OCCUR_TIME(), 140);
		ListGridField OPERATE_PERSON = new ListGridField("ADDWHO",Util.TI18N.OPERATE_PERSON(), 80);
		ListGridField OPERATE_RECODE = new ListGridField("NOTES",Util.TI18N.OPERATE_RECODE(), 170);

		logTable.setFields(DOC_NO, OPERATE_RECODE, OPERATE_PERSON, OCCUR_TIME);
		
	}
	
	
	/**
	 * 待调作业单列表
	 * @author yuanlei
	 * @param table
	 */
	private void createUnshpmField(SGTable table) {
		
		//LinkedHashMap<String, String> listMap = LoginCache.getListConfig().get("V_SHIPMENT_HEADER4D125D9FF0BB46BCBAC33D92C1076E0E");
		LinkedHashMap<String, String> listMap = LoginCache.getListConfig().get(StaticRef.V_SHIPMENT_HEADER_UNLOAD);
		createListField(table, listMap);
		ListGridField SUPLR_ID_NAME = table.getField("SUPLR_ID");
		if(SUPLR_ID_NAME != null) {
			SUPLR_ID_NAME.setCanEdit(true);
			SUPLR_ID_NAME.setTitle(ColorUtil.getRedTitle(SUPLR_ID_NAME.getTitle()));
			//Util.initOrgSupplier(SUPLR_ID_NAME, "");
			suplrLst.add(SUPLR_ID_NAME);
		}
		else {
			MSGUtil.sayError("列表中必须配置" + Util.TI18N.SUPLR_NAME());
		}
		ListGridField EXEC_ORG_ID = table.getField("EXEC_ORG_ID");
		if(EXEC_ORG_ID != null) {
			EXEC_ORG_ID.setHidden(true);
		}
		ListGridField PLATE_NO = table.getField("PLATE_NO");
		if(PLATE_NO != null) {
			PLATE_NO.setCanEdit(true);
			PLATE_NO.setTitle(ColorUtil.getBlueTitle(PLATE_NO.getTitle()));
			PLATE_NO.addEditorExitHandler(new EditorExitHandler() {

				@Override
				public void onEditorExit(EditorExitEvent event) {
					final int row = event.getRowNum();
					String plate_no = ObjUtil.ifObjNull(event.getNewValue(), "").toString();
					if(ObjUtil.isNotNull(plate_no)) {
						Util.db_async.getSingleRecord("PLATE_NO,VEHICLE_TYP_ID,DRIVER1_NAME,MOBILE1", "DRIVER1_NAME"
								, " where PLATE_NO = '" + plate_no + "'", null, new AsyncCallback<HashMap<String, String>>() {

									@Override
									public void onFailure(Throwable caught) {					
									}

									@Override
									public void onSuccess(HashMap<String, String> result) {
										if(result != null && result.size() > 0) {
											unshpmTable.setEditValue(row, "PLATE_NO", ObjUtil.ifObjNull(result.get("PLATE_NO"), "").toString());
											unshpmTable.setEditValue(row, "VEHICLE_TYP_ID", ObjUtil.ifObjNull(result.get("VEHICLE_TYP_ID"), "").toString());
											unshpmTable.setEditValue(row, "DRIVER", ObjUtil.ifObjNull(result.get("DRIVER1_NAME"), "").toString());
											unshpmTable.setEditValue(row, "MOBILE", ObjUtil.ifObjNull(result.get("MOBILE1"), "").toString());
										}
										else {
											unshpmTable.setEditValue(row, "VEHICLE_TYP_ID", "");
											unshpmTable.setEditValue(row, "DRIVER", "");
											unshpmTable.setEditValue(row, "MOBILE", "");
										}
									}
							
						});
					}
				}
				
			});
		}
		else {
			MSGUtil.sayError("列表中必须配置" + Util.TI18N.PLATE_NO());
		}
		ListGridField VEHICLE_TYP = table.getField("VEHICLE_TYP_ID");
		if(VEHICLE_TYP != null) {
			VEHICLE_TYP.setCanEdit(true);
			VEHICLE_TYP.setTitle(ColorUtil.getBlueTitle(VEHICLE_TYP.getTitle()));
			//Util.initComboValue(VEHICLE_TYP, "BAS_VEHICLE_TYPE", "ID", "VEHICLE_TYPE", " WHERE ENABLE_FLAG = 'Y'", " SHOW_SEQ ASC");  //车辆类型
			vehTypeLst.add(VEHICLE_TYP);
		}
		else {
			MSGUtil.sayError("列表中必须配置" + Util.TI18N.VEHICLE_TYPE());
		}
		ListGridField DRIVER = table.getField("DRIVER");
		if(DRIVER != null) {
			DRIVER.setCanEdit(true);
		}
		ListGridField MOBILE = table.getField("MOBILE");
		if(MOBILE != null) {
			MOBILE.setCanEdit(true);
		}
	}

	//添加作业单的作业单列表
	private void createUnshpmField1(SGTable table) {
		
		//LinkedHashMap<String, String> listMap = LoginCache.getListConfig().get("V_SHIPMENT_HEADER4D125D9FF0BB46BCBAC33D92C1076E0E");
		LinkedHashMap<String, String> listMap = LoginCache.getListConfig().get(StaticRef.V_SHIPMENT_HEADER_UNLOAD);
		createListField(table, listMap);
		ListGridField SUPLR_ID_NAME = table.getField("SUPLR_ID");
		if(SUPLR_ID_NAME != null) {
			SUPLR_ID_NAME.setCanEdit(true);
			//SUPLR_ID_NAME.setTitle(ColorUtil.getRedTitle(SUPLR_ID_NAME.getTitle()));
			//Util.initOrgSupplier(SUPLR_ID_NAME, "");
			suplrLst.add(SUPLR_ID_NAME);
		}
		else {
			MSGUtil.sayError("列表中必须配置" + Util.TI18N.SUPLR_NAME());
		}
		ListGridField EXEC_ORG_ID = table.getField("EXEC_ORG_ID");
		if(EXEC_ORG_ID != null) {
			EXEC_ORG_ID.setHidden(true);
		}
		ListGridField PLATE_NO = table.getField("PLATE_NO");
		if(PLATE_NO != null) {
			PLATE_NO.setCanEdit(true);
			//PLATE_NO.setTitle(ColorUtil.getBlueTitle(PLATE_NO.getTitle()));
			PLATE_NO.addEditorExitHandler(new EditorExitHandler() {

				@Override
				public void onEditorExit(EditorExitEvent event) {
					final int row = event.getRowNum();
					String plate_no = ObjUtil.ifObjNull(event.getNewValue(), "").toString();
					if(ObjUtil.isNotNull(plate_no)) {
						Util.db_async.getSingleRecord("PLATE_NO,VEHICLE_TYP_ID,DRIVER1_NAME,MOBILE1", "DRIVER1_NAME"
								, " where PLATE_NO = '" + plate_no + "'", null, new AsyncCallback<HashMap<String, String>>() {

									@Override
									public void onFailure(Throwable caught) {					
									}

									@Override
									public void onSuccess(HashMap<String, String> result) {
										if(result != null && result.size() > 0) {
											unshpmTable.setEditValue(row, "PLATE_NO", ObjUtil.ifObjNull(result.get("PLATE_NO"), "").toString());
											unshpmTable.setEditValue(row, "VEHICLE_TYP_ID", ObjUtil.ifObjNull(result.get("VEHICLE_TYP_ID"), "").toString());
											unshpmTable.setEditValue(row, "DRIVER", ObjUtil.ifObjNull(result.get("DRIVER1_NAME"), "").toString());
											unshpmTable.setEditValue(row, "MOBILE", ObjUtil.ifObjNull(result.get("MOBILE1"), "").toString());
										}
										else {
											unshpmTable.setEditValue(row, "VEHICLE_TYP_ID", "");
											unshpmTable.setEditValue(row, "DRIVER", "");
											unshpmTable.setEditValue(row, "MOBILE", "");
										}
									}
							
						});
					}
				}
				
			});
		}
		else {
			MSGUtil.sayError("列表中必须配置" + Util.TI18N.PLATE_NO());
		}
		ListGridField VEHICLE_TYP = table.getField("VEHICLE_TYP_ID");
		if(VEHICLE_TYP != null) {
			VEHICLE_TYP.setCanEdit(true);
			//VEHICLE_TYP.setTitle(ColorUtil.getBlueTitle(VEHICLE_TYP.getTitle()));
			//Util.initComboValue(VEHICLE_TYP, "BAS_VEHICLE_TYPE", "ID", "VEHICLE_TYPE", " WHERE ENABLE_FLAG = 'Y'", " SHOW_SEQ ASC");  //车辆类型
			vehTypeLst.add(VEHICLE_TYP);
		}
		else {
			MSGUtil.sayError("列表中必须配置" + Util.TI18N.VEHICLE_TYPE());
		}
		ListGridField DRIVER = table.getField("DRIVER");
		if(DRIVER != null) {
			DRIVER.setCanEdit(true);
		}
		ListGridField MOBILE = table.getField("MOBILE");
		if(MOBILE != null) {
			MOBILE.setCanEdit(true);
		}
	}
	
	public void createBtnWidget(ToolStrip toolStrip) {
		//组件按钮
		toolStrip.setWidth("100%");
		toolStrip.setHeight("20");
		toolStrip.setPadding(2);
		toolStrip.setSeparatorSize(12);
		toolStrip.addSeparator();
		//作业单按钮
		searchButton=createUDFBtn(Util.BI18N.SEARCHSHPM(), StaticRef.ICON_SEARCH, TrsPrivRef.DISPATCH_P1_01);
		searchButton.addClickHandler(new ClickHandler() {
			
			@Override
			public void onClick(ClickEvent event) {
				if(searchWin!=null){
					searchWin.hide();
				}
				if(shipwin==null){
					chooseForm=new SGPanel();
					shipwin= new UnshpmQueryWin(584,380,unshpmDS,subView.createUnshpmQueryForm(chooseForm),topSectionStack.getSection(0)).getViewPanel();
				}
				else{
					shipwin.show();
				}
			}
		});
		
	    //调度单按钮
	    IButton loadButton = createUDFBtn(Util.BI18N.SEARCHLOAD(), StaticRef.ICON_SEARCH, TrsPrivRef.DISPATCH_P2_01);
	    loadButton.addClickHandler(new ClickHandler() {

			@Override
			public void onClick(ClickEvent event) {
				if(shipwin!=null){
					shipwin.hide();
				}
			   if(searchWin==null){
				   searchForm=new SGPanel();
				   searchForm.setDataSource(unshpmDS);
			       searchWin = new SearchWin(loadDS, subView.createSerchForm(searchForm),
				   downSectionStack.getSection(0)).getViewPanel();
			   }
			   else{
					searchWin.show();
			   }			
			}
	    });
        
	    //生成调度单按钮
	    shpmButton = createUDFBtn(Util.BI18N.CREATELOAD(), StaticRef.ICON_SAVE, TrsPrivRef.DISPATCH_P2_02);
	    shpmButton.addClickHandler(new MakeLoadNoAction(unshpmTable, loadTable, getView()));
        
        //保存按钮
        saveButton = createBtn(StaticRef.SAVE_BTN, TrsPrivRef.DISPATCH_P2_03);
        saveButton.addClickHandler(new SaveLoadNoAction(loadTable,check_map, getView()));
        
        //删除按钮
        delButton = createBtn(StaticRef.DELETE_BTN, TrsPrivRef.DISPATCH_P2_04);
        delButton.addClickHandler(new DeleteLoadNoAction(loadTable, this));
        
        //取消按钮
        canButton = createBtn(StaticRef.CANCEL_BTN, TrsPrivRef.DISPATCH_P2_05);
        canButton.addClickHandler(new CancelAction(loadTable));
        
	    //确认发运按钮
	    confirmButton = createUDFBtn(Util.BI18N.SENDCONFIRM(), StaticRef.ICON_CONFIRM, TrsPrivRef.DISPATCH_P2_06);
	    confirmButton.addClickHandler(new LoadSendConfirmAction(getView(), loadTable, shpmTable));
	    
	    //取消发运按钮
	    cansendButton = createUDFBtn(Util.BI18N.CANCELSEND(), StaticRef.ICON_CANCEL, TrsPrivRef.DISPATCH_P2_07);
	    cansendButton.addClickHandler(new LoadCancelSendAction(getView(), loadTable, shpmTable));
	    
	    //提货单打印预览
//	    loadBillButton = createUDFBtn("打印调度单", StaticRef.ICON_PRINT, TrsPrivRef.DISPATCH_P2_08);
//	    loadBillButton.addClickHandler(new ShipPrintAction(this,loadTable, "b2b调度单"));
//	    
//	    //提货单打印
//	    loadDoBillButton = createUDFBtn("打印调度单", StaticRef.ICON_PRINT, TrsPrivRef.DISPATCH_P2_08);
//	    loadDoBillButton.addClickHandler(new ShipPrintAction(this,loadTable, "干线调度单"));
//	    //送货单打印
//	    sendBillButton = createUDFBtn("打印调度单", StaticRef.ICON_PRINT, TrsPrivRef.DISPATCH_P2_09);
//	    sendBillButton.addClickHandler(new ShipPrintAction(this,loadTable,"派送调度单"));
//        
//	    IButton suihdButton = createUDFBtn("打印调度单", StaticRef.ICON_PRINT, TrsPrivRef.DISPATCH_P2_09);
//	    suihdButton.addClickHandler(new ShipPrintAction(this,loadTable,"提货调度单"));
        //导出按钮
        //IButton expButton = createBtn(StaticRef.EXPORT_BTN, TrsPrivRef.DISPATCH_P2_10);
        //expButton.addClickHandler(new ExportAction(loadTable));
    
        del_map.put(TrsPrivRef.DISPATCH_P2_04, delButton);
        save_map.put(TrsPrivRef.DISPATCH_P2_03, saveButton);
        save_map.put(TrsPrivRef.DISPATCH_P2_05, canButton);
        sendMap.put(TrsPrivRef.DISPATCH_P2_06, confirmButton);
        sendMap.put(TrsPrivRef.DISPATCH_P2_07, cansendButton);
        enableOrDisables(del_map, true);
        enableOrDisables(save_map, false);
        setConfirmBtnStatus(false);
        setButtonEnabled(TrsPrivRef.DISPATCH_P2_02,shpmButton,true);
        toolStrip.setMembersMargin(4);
        toolStrip.setMembers(searchButton, loadButton, shpmButton, saveButton, delButton, canButton, confirmButton, cansendButton);
	  
	}

	public void createForm(DynamicForm form) {
		
	}

	public void initVerify() {
		check_map.put("TABLE", "TRANS_LOAD_HEADER");		
		check_map.put("START_AREA_ID", StaticRef.CHK_UNIQUE + Util.TI18N.START_ARAE());		
		check_map.put("END_AREA_ID", StaticRef.CHK_NOTNULL + Util.TI18N.END_AREA());
		check_map.put("SUPLR_NAME", StaticRef.CHK_UNIQUE + Util.TI18N.SUPLR_NAME());		
		check_map.put("PLATE_NO", StaticRef.CHK_NOTNULL + Util.TI18N.PLATE_NO());
		check_map.put("DEPART_TIME", StaticRef.CHK_DATE+ Util.TI18N.END_LOAD_TIME());
		check_map.put("DONE_TIME", StaticRef.CHK_DATE+ "预计回场时间");
	}

	public void onDestroy() {
	  if (searchWin != null) {
		  searchWin.destroy();
	  }if(transTrackWin !=null){
		  transTrackWin.destroy();
	  }if(dispLoadWin !=null){
		  dispLoadWin.destroy();
	  }if(unDispLoadWin != null){
		  unDispLoadWin.destroy();
	  }
	}
	
	private void addRightKey() {
		final Menu menu = new Menu();   //待调右键
	    menu.setWidth(140);
	    MenuItemSeparator itemSeparator =new MenuItemSeparator();
	    
	    if(isPrivilege(TrsPrivRef.DISPATCH_P2_24)){                          //待调右键权限    wangjun 2010-3-9
		    if(isPrivilege(TrsPrivRef.DISPATCH_P1_02)) {
			    MenuItem addItem = new MenuItem("加入调度单",StaticRef.ICON_NEW);
			    addItem.setKeyTitle("Alt+A");
			    KeyIdentifier addKey = new KeyIdentifier();
			    addKey.setAltKey(true);
			    addKey.setKeyName("A");
			    addItem.setKeys(addKey);
			    menu.addItem(addItem);
			    addItem.addClickHandler(new AddShpmNoAction(this,unshpmTable, loadTable));
		    }
		    
		    if(isPrivilege(TrsPrivRef.DISPATCH_P1_03)) {
			    MenuItem refreshItem = new MenuItem(Util.BI18N.REFRESH(),StaticRef.ICON_REFRESH);
			    refreshItem.setKeyTitle("Alt+F");
			    KeyIdentifier refreshKey = new KeyIdentifier();
			    refreshKey.setAltKey(true);
			    refreshKey.setKeyName("F");
			    refreshItem.setKeys(refreshKey);
			    menu.addItem(refreshItem);
			    qryUnshpmTableAction = new QueryUnshpmTableAction(unshpmTable, sumForm, pageForm);
			    refreshItem.addClickHandler(qryUnshpmTableAction);
			    
		    }
		    
		    if(isPrivilege(TrsPrivRef.DISPATCH_P2_34)) {//保存
			    MenuItem saveItem = new MenuItem(Util.BI18N.SAVE(),StaticRef.ICON_SAVE);
			    menu.addItem(saveItem);
			    saveItem.addClickHandler(new UnShpmSaveAction(unshpmTable));
			    
		    }
		   
		    
		    /*if(isPrivilege(TrsPrivRef.DISPATCH_P1_04)) {
		    	menu.addItem(itemSeparator);
			    MenuItem viewItem = new MenuItem(Util.BI18N.VIEWSHPM(),StaticRef.ICON_SEARCH);
			    viewItem.setKeyTitle("Alt+V");
			    KeyIdentifier viewKey = new KeyIdentifier();
			    viewKey.setAltKey(true);
			    viewKey.setKeyName("V");
			    viewItem.setKeys(viewKey);
			    menu.addItem(viewItem);
			    viewItem.addClickHandler(new com.smartgwt.client.widgets.menu.events.ClickHandler() {
	
					@Override
					public void onClick(MenuItemClickEvent event) {
						 //new ShipWin(550,420,unshpmDS,null,topSectionStack.getSection(0)).getViewPanel();
						if(unshpmTable.getSelection().length == 1) {
							ListGridRecord rec = unshpmTable.getSelectedRecord();
							String strWhere = " and SHPM_NO != '" + rec.getAttribute("SHPM_NO") + "'";
							transTrackWin=new TransTrackWin(rec.getAttribute("ODR_NO"), strWhere).getViewPanel();
						}
						else {
							SC.warn("请选择一个作业单！");
						}
					}
			    	
			    });
			    
			    
		    }*/
		    /*if(isPrivilege(TrsPrivRef.DISPATCH_P1_04)) {
		    	menu.addItem(itemSeparator); 
			    MenuItem inItem = new MenuItem("作业单补码",StaticRef.ICON_CONFIRM); 
			    menu.addItem(inItem);
			    inItem.addClickHandler(new com.smartgwt.client.widgets.menu.events.ClickHandler() {

			    	@Override
					public void onClick(MenuItemClickEvent event) {
						// TODO Auto-generated method stub
						if(unshpmTable != null && unshpmTable.getSelection().length > 0){
							//弹出窗口
							new ModifyShpmWin(unshpmTable, unshpmTable.getSelection());
							
						} else {
							SC.warn("请选择作业单!");
						}
					}
			    	
			    });		    
		    }*/
		    
		    if(isPrivilege(TrsPrivRef.DISPATCH_P2_33)) {
		    	 MenuItem UnShpmPrintItem = new MenuItem("打印提货单",StaticRef.ICON_PRINT);
		    	 UnShpmPrintItem.addClickHandler(new UnShpmPrintAction(this,unshpmTable));
		    	 menu.addItem(UnShpmPrintItem);
		    	 Menu m = new Menu();
		    	 MenuItem b2bPrintItem = new MenuItem("打印冷运专运调度单",StaticRef.ICON_PRINT);
		 		 b2bPrintItem.addClickHandler(new DispatchPrintAction(loadTable, "b2bDispatch"));
		 		 MenuItem gxPrintItem = new MenuItem("打印干线调度单",StaticRef.ICON_PRINT);
		 		 gxPrintItem.addClickHandler(new DispatchPrintAction(loadTable, "arteryDispatch"));
		 		 MenuItem psPrintItem = new MenuItem("打印零担派送调度单",StaticRef.ICON_PRINT);
		 		 psPrintItem.addClickHandler(new DispatchPrintAction(loadTable, "sendDispatch"));
//		 		 MenuItem tfqdPrintItem = new MenuItem("打印提货清单",StaticRef.ICON_PRINT);
//		 		 tfqdPrintItem.addClickHandler(new DispatchPrintAction(loadTable, "deliveryManifest"));
		 		 MenuItem tfPrintItem = new MenuItem("打印零担提货调度单",StaticRef.ICON_PRINT);
		 		 tfPrintItem.addClickHandler(new DispatchPrintAction(loadTable, "deliveryDispatch"));
//		 		 MenuItem b2cPrintItem = new MenuItem("打印B2C派送调度出库单",StaticRef.ICON_PRINT);
//		 		 b2cPrintItem.addClickHandler(new DispatchPrintAction(loadTable, "b2cDispatch"));
//		 		 MenuItem b2cRoutePrintItem = new MenuItem("打印B2C直送调度出库单",StaticRef.ICON_PRINT);
//		 		 b2cRoutePrintItem.addClickHandler(new DispatchPrintAction(loadTable, "b2cRouteDispatch"));
		 		 
		 		 MenuItem b2cPrintItem = new MenuItem("打印冷运速配调度出库单",StaticRef.ICON_PRINT);
		 		 b2cPrintItem.addClickHandler(new DispatchPrintAction(loadTable, "b2cDispatch"));
		 		 
//		 		MenuItem newDispatch=new MenuItem("打印不干胶模板",StaticRef.ICON_PRINT);
//				newDispatch.addClickHandler(new DispatchPrintAction(loadTable,"newDispatch"));
//				m.addItem(newDispatch);
				
		    	 m.addItem(b2bPrintItem);
		    	 m.addItem(gxPrintItem);
		    	 m.addItem(psPrintItem);
//		    	 m.addItem(tfqdPrintItem);
		    	 m.addItem(tfPrintItem);
		    	 m.addItem(b2cPrintItem);
//				 m.addItem(newDispatch);
//		    	 m.addItem(b2cRoutePrintItem);
		    	 UnShpmPrintItem.setSubmenu(m);
		    }
		    
		    /*if(true) {
		    	menu.addItem(itemSeparator); 
		    	MenuItem groupItem = new MenuItem("作业单编组",StaticRef.ICON_CONFIRM);
		    	groupItem.addClickHandler(new ShpmGroupAction(getView(),unshpmTable));
		    	menu.addItem(groupItem);
		    	
		    	menu.addItem(itemSeparator); 
		    	MenuItem vehItem = new MenuItem("按运力拆分",StaticRef.ICON_CONFIRM);
		    	vehItem.addClickHandler(new SplitByCapacityAction(getView(),unshpmTable));
		    	menu.addItem(vehItem);
		    }*/
		    
		    if(isPrivilege(TrsPrivRef.DISPATCH_P1_05)) {
		    	menu.addItem(itemSeparator); 
			    MenuItem splitItem = new MenuItem("分量拆分",StaticRef.ICON_CONFIRM);
			    splitItem.setKeyTitle("Alt+S");
			    KeyIdentifier splitKey = new KeyIdentifier();
			    splitKey.setAltKey(true);
			    splitKey.setKeyName("S");
			    splitItem.setKeys(splitKey);
			    menu.addItem(splitItem);
			    splitItem.addClickHandler(new com.smartgwt.client.widgets.menu.events.ClickHandler() {
	
					@Override
					public void onClick(MenuItemClickEvent event) {
						
						if(unshpmlstTable != null && unshpmlstTable.getSelection().length > 0){
							if(isSplitValid()) {
								new SplitActionWin(unshpmlstTable, unshpmTable, getView()).getViewPanel().show();
							}
							
						} else {
							SC.warn("未勾选作业单明细!");
						}			
					}
			    });
		    }
		    
		    if(isPrivilege(TrsPrivRef.DISPATCH_P1_06)) {
			    MenuItem cansplitItem = new MenuItem(Util.BI18N.CANCELSPLIT(),StaticRef.ICON_CANCEL); 
			    cansplitItem.setKeyTitle("Alt+C");
			    KeyIdentifier cansplitKey = new KeyIdentifier();
			    cansplitKey.setAltKey(true);
			    cansplitKey.setKeyName("C");
			    cansplitItem.setKeys(cansplitKey);
			    menu.addItem(cansplitItem);
			    cansplitItem.addClickHandler(new CancelSplitAction(getView(), unshpmTable));
			    
		    }
		    if(isPrivilege(TrsPrivRef.DISPATCH_P1_07)) {
		    	menu.addItem(itemSeparator); 
			    MenuItem splitJrnyItem = new MenuItem("行程拆分",StaticRef.ICON_CONFIRM);
			    splitJrnyItem.setKeyTitle("Alt+S");
			    menu.addItem(splitJrnyItem);
			    splitJrnyItem.addClickHandler(new com.smartgwt.client.widgets.menu.events.ClickHandler() {
	
					@Override
					public void onClick(MenuItemClickEvent event) {
						if(unshpmTable.getSelectedRecord().getAttribute("PRINT_FLAG").equals("N")){
							
							SC.warn("作业单"+unshpmTable.getSelectedRecord().getAttribute("SHPM_NO")+" 已打印提货单不允许拆分！");
							return;
						}
						
						if(unshpmTable != null && unshpmTable.getSelection().length > 0){
							//弹出窗口
							new JourneySplitWin(getView(), unshpmTable.getSelection());
							
						} else {
							SC.warn("请选择作业单!");
						}			
					}
			    });
		    }
		    
		    if(isPrivilege(TrsPrivRef.DISPATCH_P1_08)) {
			    MenuItem canJnrysplitItem = new MenuItem("取消行程拆分",StaticRef.ICON_CANCEL); 
			    menu.addItem(canJnrysplitItem);
			    canJnrysplitItem.addClickHandler(new CancelJourneySplitAction(getView(), unshpmTable));
			    
		    }
		    
		    if(isPrivilege(TrsPrivRef.DISPATCH_P2_25)) {
		    	menu.addItem(itemSeparator);
				MenuItem expList = new MenuItem(Util.BI18N.EXPORT(),StaticRef.ICON_EXPORT);  //导出
				menu.addItem(expList);
			    expList.addClickHandler(new ExportAction(unshpmTable));
		    }   
		    if(isPrivilege(TrsPrivRef.DISPATCH_P2_26)) {
				MenuItem expList = new MenuItem("明细导出",StaticRef.ICON_EXPORT);  //导出
				menu.addItem(expList);
//			    expList.addClickHandler(new ExportShpmItemAction(unshpmTable, " order by shpm_no,shpm_row asc "));
				expList.addClickHandler(new ExportShpmItemAction(unshpmTable, " order by UNLOAD_AREA_ID ,nvl(edittime,addtime) desc "));
		    }  
		    
		    unshpmTable.addShowContextMenuHandler(new ShowContextMenuHandler() {
	            public void onShowContextMenu(ShowContextMenuEvent event) {
	            	menu.showContextMenu();
	                event.cancel();
	            }
	        });
	    }
	    
	}
	
	private DispatchView getView() {
		return this;
	}
	
	//获取系统参数值
	private void getSysParam() {
		LinkedHashMap<String, SysParam> sysParam = LoginCache.getSysParam();
		if(sysParam != null) {
			SysParam param = sysParam.get("LOAD_QNTYCANEDIT");
			if(param != null) {
				canModify = param.getVALUE_STRING();
			}
			else {
				canModify = "N";
			}
			param = sysParam.get("VEHICLE_INPUT");
			if(param != null) {
				canVehInput = param.getVALUE_STRING();
			}
			else {
				canVehInput = "Y";
			}
		}
		else {
			MSGUtil.sayWarning("系统参数缓存未加载完毕，请重新打开界面!");
			return;
		}
	}
	
	public void setSendBtnStatus(boolean bolSet) {
		setButtonEnabled(TrsPrivRef.DISPATCH_P2_06, confirmButton, bolSet);
		setButtonEnabled(TrsPrivRef.DISPATCH_P2_07, cansendButton, !bolSet);
	}
	
	public void setConfirmBtnStatus(boolean bolSet) {
		setButtonEnabled(TrsPrivRef.DISPATCH_P2_06, confirmButton, bolSet);
		setButtonEnabled(TrsPrivRef.DISPATCH_P2_07, cansendButton, bolSet);
	}
	
	public void setSaveBtnStatus(boolean bolSet) {
        enableOrDisables(save_map, bolSet);
	}
	
	public void setDelBtnStatus(boolean bolSet) {
		enableOrDisables(del_map, bolSet);
	}
	
	/**
	 * 判断拆分是否合法
	 * @author yuanlei
	 * @return
	 */
	protected boolean isSplitValid(){
		boolean isAllMaxSplit = true;
		
		if(unshpmlstTable != null) {
			ListGridRecord[] records = unshpmlstTable.getSelection();
			int[] edit_rows = new int[records.length];
			for(int i = 0; i < records.length; i++) {
				edit_rows[i] = unshpmlstTable.getRecordIndex(records[i]);
			}
			Record rec = null;
			
			for(int i = 0; i < edit_rows.length; i++) {
				
				ListGridRecord initRecord = unshpmlstRec[edit_rows[i]];
				rec = unshpmlstTable.getEditedRecord(edit_rows[i]);
				double cur_qnty = Double.parseDouble(ObjUtil.ifObjNull(rec.getAttribute("QNTY"),"0").toString());
				double init_qnty = Double.parseDouble(ObjUtil.ifObjNull(initRecord.getAttribute("QNTY"),"0").toString());
				double rate = getRate(cur_qnty, init_qnty);
				if(rate > 1) {
					SC.warn("行号[" + rec.getAttribute("SHPM_ROW") + "]数量不能大于原单量!");
					return false;
				}
				else if(rate < 1) {
					isAllMaxSplit = false;
				}
			}
			if(records.length == unshpmlstTable.getRecords().length && isAllMaxSplit) {
				SC.warn("无效的拆分操作!");
				return false;
			}
			return true;
		}
		else {
			SC.warn("无效的拆分操作!");
			return false;
		}
	}
	
    private double getRate(double douPart, double douTotal) {
    	  
	    double rate = 0.0000;
	    if(douTotal > 0) {
	    	rate = douPart/douTotal;
	    }
	    return rate;
    }
    
    private void createFeeInfo() {
		// 费用明细
    	feeTable = new SGTable(billDS) {
    		protected Canvas getExpansionComponent(final ListGridRecord record) { 
    			VLayout layout = new VLayout(5);
                
                feeitemTable = new ListGrid();
                feeitemTable.setDataSource(billItemDS);
                feeitemTable.setWidth("78%");
                feeitemTable.setHeight(46);
                feeitemTable.setCellHeight(22);
                feeitemTable.setCanEdit(false);
                feeitemTable.setAutoFitData(Autofit.VERTICAL);
                
                ListGridField SHPM_NO = new ListGridField("DOC_NO", Util.TI18N.SHPM_NO(), 100);
        		ListGridField FEE_ID = new ListGridField("FEE_NAME", Util.TI18N.FEE_NAME(), 80);
        		ListGridField FEE_BAS = new ListGridField("FEE_BAS_NAME",Util.TI18N.FEE_BASE(), 80);
        		ListGridField BAS_VALUE = new ListGridField("BAS_VALUE",Util.TI18N.BAS_VALUE(), 70);
        		ListGridField PRICE = new ListGridField("PRICE", Util.TI18N.PRICE(), 60);
        		ListGridField PRE_FEE = new ListGridField("PRE_FEE", Util.TI18N.PRE_FEE(), 80);
        		ListGridField DUE_FEE = new ListGridField("DUE_FEE",Util.TI18N.DUE_FEE(), 80);
        		ListGridField PAY_FEE = new ListGridField("PAY_FEE","实付费用", 80);
        		feeitemTable.setFields(SHPM_NO,FEE_ID, FEE_BAS, BAS_VALUE, PRICE, PRE_FEE,DUE_FEE,PAY_FEE);
        		
        		Record feeRecord = feeTable.getSelectedRecord();
        		Criteria criteria = new Criteria();
				criteria.addCriteria("OP_FLAG","M");
				criteria.addCriteria("LOAD_NO",feeRecord.getAttributeAsString("LOAD_NO"));
				criteria.addCriteria("FEE_NAME",feeRecord.getAttributeAsString("FEE_NAME"));
				
				feeitemTable.fetchData(criteria);
        		
        		layout.addMember(feeitemTable);
                layout.setLayoutLeftMargin(35);
				return layout;     
    		}
    	};
    	feeTable.setCanExpandRecords(true);
    	feeTable.setShowFilterEditor(false);
    	feeTable.setShowRowNumbers(true);

        ListGridField LOAD_NO = new ListGridField("LOAD_NO", Util.TI18N.LOAD_NO(), 100);
		ListGridField FEE_ID = new ListGridField("FEE_NAME", Util.TI18N.FEE_NAME(), 100);
		//Util.initComboValue(FEE_ID, "V_TRANS_CHARGE_TYPE", "ID", "FEE_NAME", "", "");
		ListGridField FEE_BAS = new ListGridField("FEE_BAS_NAME",Util.TI18N.FEE_BASE(), 80);
		//Util.initComboValue(FEE_BAS, "BAS_CODES", "CODE", "NAME_C", " where PROP_CODE = 'FEE_BASE'", "");
		ListGridField BAS_VALUE = new ListGridField("BAS_VALUE",Util.TI18N.BAS_VALUE(), 80);
		ListGridField PRICE = new ListGridField("PRICE", Util.TI18N.PRICE(), 80);
		ListGridField PRE_FEE = new ListGridField("PRE_FEE", Util.TI18N.PRE_FEE(), 80);
		ListGridField DISCOUNT_RATE = new ListGridField("DISCOUNT_RATE", Util.TI18N.DISCOUNT(), 80);
		ListGridField DUE_FEE = new ListGridField("DUE_FEE",Util.TI18N.DUE_FEE(), 80);
		ListGridField PAY_FEE = new ListGridField("PAY_FEE","实付费用", 80);
		ListGridField NOTES = new ListGridField("NOTES", Util.TI18N.NOTES(), 80);
		feeTable.setFields(LOAD_NO, FEE_ID, FEE_BAS, BAS_VALUE,PRICE, PRE_FEE, DISCOUNT_RATE, DUE_FEE, PAY_FEE, NOTES);

    }
    
    private void initArea(final SGTable table, final ListGridField AREA_NAME, String area_code, String area_cname, String defaultValue) {
		final String code = area_code;
		final String name = area_cname;
		DataSource ds = VCAreaDS.getInstance("VC_BAS_AREA");
		
		ListGridField AREA_CODE = new ListGridField("AREA_CODE", Util.TI18N.AREA_CODE(), 70);
		ListGridField SHOW_NAME = new ListGridField("SHORT_NAME", Util.TI18N.SHORT_NAME(), 90);
		ListGridField HINT_CODE = new ListGridField("HINT_CODE", Util.TI18N.HINT_CODE(), 60);
		final ComboBoxItem area_name = new ComboBoxItem();
		area_name.setColSpan(2);
		area_name.setWidth(120);
		area_name.setOptionDataSource(ds);  
		area_name.setDisabled(false);
		area_name.setShowDisabled(false);
		area_name.setDisplayField("CONTENT");
		area_name.setValueField("SHORT_NAME");
		area_name.setPickListWidth(240);
		area_name.setPickListBaseStyle("myBoxedGridCell");
		area_name.setPickListFields(AREA_CODE, SHOW_NAME, HINT_CODE);
	
		Criteria criteria = new Criteria();
		criteria.addCriteria("OP_FLAG","M");
		area_name.setPickListCriteria(criteria);
		
		AREA_NAME.setEditorType(area_name);
		AREA_NAME.addEditorExitHandler(new EditorExitHandler() {

			@Override
			public void onEditorExit(EditorExitEvent event) {
				Object obj = event.getNewValue();
				final int rowNum = event.getRowNum();
				if(obj != null) {
					final Record rec = event.getRecord();
					if(obj.toString().equals("")) {
						SC.say("未找到匹配的行政区域!");
						if(rec != null) {
							table.setEditValue(rowNum, code, rec.getAttribute(code));
							table.setEditValue(rowNum, name, rec.getAttribute(name));
						}
						else {
							table.setEditValue(rowNum, code, "");
							table.setEditValue(rowNum, name, "");
						}
					}
					else {
						String curValue = ObjUtil.ifObjNull(event.getNewValue(),"").toString();
						Util.async.queryData("select AREA_CODE,SHORT_NAME from VC_AREA where AREA_CODE='"+
								curValue+"' or upper(AREA_CNAME)=upper('"+curValue+
								"') or upper(SHORT_NAME)=upper('"+curValue+
								"')", false, new AsyncCallback<Map<String,Object>>() {
							@Override
							public void onFailure(Throwable caught) {
								
							}
							@SuppressWarnings("unchecked")
							@Override
							public void onSuccess(Map<String, Object> result) {
								List<List<String>> list = (List<List<String>>)result.get("data");
								if(list == null || list.isEmpty()){
									SC.say("未能找到指定的区域!");
									return;
								}
								table.setEditValue(rowNum, code, list.get(0).get(0));
								table.setEditValue(rowNum, name, list.get(0).get(1));
								if(rec != null){
									rec.setAttribute(code, list.get(0).get(0));
									rec.setAttribute(name, list.get(0).get(1));
								}
							}
						});
					}
				}
			}
			
		});
	}
    private void createVeField(SGTable table) {
		ListGridField PLATE_NO1 = new ListGridField("PLATE_NO",Util.TI18N.PLATE_NO(),140);
		ListGridField VEHICLE_STAT1 = new ListGridField("VEHICLE_STAT_NAME",Util.TI18N.VEHICLE_STAT(),120);
		ListGridField CURRENT_AREA = new ListGridField("CURRENT_AREA","当前区域",160);
		ListGridField TMP_ATTR1 = new ListGridField("TMP_ATTR_NAME",Util.TI18N.TMP_ATTR(),160);
		ListGridField AVAIL_FLAG = new ListGridField("AVAIL_FLAG_NAME",Util.TI18N.AVAIL_ATTR(),140);
		ListGridField VEHICLE_TYP_ID_NAME = new ListGridField("VEHICLE_TYP_ID_NAME",Util.TI18N.VEHICLE_TYP(),170);
		ListGridField MAX_WEIGHT1 = new ListGridField("MAX_WEIGHT1",Util.TI18N.MAX_WEIGHT(),140);
		ListGridField REMAIN_GROSS_W1 = new ListGridField("REMAIN_GROSS_W","余量",140);
		ListGridField SUPLR_NAME = new ListGridField("SUPLR_ID_NAME",Util.TI18N.SUPLR_NAME(),160);
		table.setFields(PLATE_NO1,VEHICLE_STAT1,REMAIN_GROSS_W1,TMP_ATTR1, CURRENT_AREA, AVAIL_FLAG, VEHICLE_TYP_ID_NAME,MAX_WEIGHT1, SUPLR_NAME);
	}   
    
    public void createVeBtnWidget(ToolStrip toolStrip) {
    	toolStrip.setWidth("100%");
		toolStrip.setHeight("20");
		toolStrip.setPadding(2);
		toolStrip.setSeparatorSize(12);
		toolStrip.addSeparator();
		//车辆筛选按钮
		IButton searchButton=createUDFBtn("筛选车辆", StaticRef.ICON_SEARCH, TrsPrivRef.Vehicle_P1_01);
		searchButton.addClickHandler(new ClickHandler() {
			
			@Override
			public void onClick(ClickEvent event) {
				if(searchWin!=null){
					searchWin.hide();
				}
				if(shipwin!=null){
					shipwin.hide();
				}
				if(veWin==null){
					veForm=new SGPanel();
					veWin= new UnshpmQueryWin(800,280,ds,subView.createVehicleQueryForm(veForm),topSectionStack2.getSection(0)).getViewPanel();
				}
				else{
					veWin.show();
				}
			}
		});
		 IButton addShpmButton=createUDFBtn("添加作业单", StaticRef.CREATE_BTN, TrsPrivRef.Vehicle_P1_02);
		 addShpmButton.addClickHandler(new ClickHandler() {

				@Override
				public void onClick(ClickEvent event) {
					if(shipwin!=null){
						shipwin.hide();
					}
					 if(searchWin!=null){
						 searchWin.hide();
					 }
					 if(veWin!=null){
						 veWin.hide();
					 }
				   if(shpmWin==null){
					   shpmWin=getShpTable();
					   shpmWin.show();
				   }
				   else{
					   shpmWin.show();
				   }			
				}
		    });
		
	    //调度单按钮
	    IButton loadButton = createUDFBtn(Util.BI18N.SEARCHLOAD(), StaticRef.ICON_SEARCH, TrsPrivRef.Vehicle_P1_03);
	    loadButton.addClickHandler(new ClickHandler() {

			@Override
			public void onClick(ClickEvent event) {
				if(shipwin!=null){
					shipwin.hide();
				}
			   if(searchWin==null){
				   searchForm=new SGPanel();
				   searchForm.setDataSource(unshpmDS);
			       searchWin = new SearchWin(loadDS, subView.createSerchForm(searchForm),
				   downSectionStack.getSection(0)).getViewPanel();
			   }
			   else{
					searchWin.show();
			   }			
			}
	    });
        
	    //生成调度单按钮
	    shpmButton = createUDFBtn(Util.BI18N.CREATELOAD(), StaticRef.ICON_SAVE, TrsPrivRef.Vehicle_P1_04);
	    shpmButton.addClickHandler(new MakeLoadNoAction(unshpmTable, loadTable, getView()));
        
        //保存按钮
        saveButton = createBtn(StaticRef.SAVE_BTN, TrsPrivRef.Vehicle_P1_05);
        saveButton.addClickHandler(new SaveLoadNoAction(loadTable,check_map, getView()));
        
        //删除按钮
        delButton = createBtn(StaticRef.DELETE_BTN, TrsPrivRef.Vehicle_P1_06);
        delButton.addClickHandler(new DeleteLoadNoAction(loadTable, this));
        
        //取消按钮
        canButton = createBtn(StaticRef.CANCEL_BTN, TrsPrivRef.Vehicle_P1_07);
        canButton.addClickHandler(new CancelAction(loadTable));
        
	    //确认发运按钮
	    confirmButton = createUDFBtn(Util.BI18N.SENDCONFIRM(), StaticRef.ICON_CONFIRM, TrsPrivRef.Vehicle_P1_08);
	    confirmButton.addClickHandler(new LoadSendConfirmAction(getView(), loadTable, shpmTable));
	    
	    //取消发运按钮
	    cansendButton = createUDFBtn(Util.BI18N.CANCELSEND(), StaticRef.ICON_CANCEL, TrsPrivRef.Vehicle_P1_09);
	    cansendButton.addClickHandler(new LoadCancelSendAction(getView(), loadTable, shpmTable));
	    

        del_map.put(TrsPrivRef.Vehicle_P1_06, delButton);
        save_map.put(TrsPrivRef.Vehicle_P1_05, saveButton);
        save_map.put(TrsPrivRef.Vehicle_P1_07, canButton);
        sendMap.put(TrsPrivRef.Vehicle_P1_08, confirmButton);
        sendMap.put(TrsPrivRef.Vehicle_P1_09, cansendButton);
        enableOrDisables(del_map, true);
        enableOrDisables(save_map, false);
        setConfirmBtnStatus(false);
        setButtonEnabled(TrsPrivRef.Vehicle_P1_04,shpmButton,false);
        toolStrip.setMembersMargin(4);
        toolStrip.setMembers(searchButton,addShpmButton,loadButton, shpmButton, saveButton, delButton, canButton, confirmButton, cansendButton);
	
    }
    private void initCombo() {
    	//initArea(loadTable,START_AREA,"START_AREA_ID", "START_AREA_NAME", "");
    	Util.initComboBatch(vehTypeLst, "BAS_VEHICLE_TYPE", "ID", "VEHICLE_TYPE", " WHERE ENABLE_FLAG = 'Y'", " SHOW_SEQ ASC", null);  //车辆类型
    	Util.initOrgSupplier(suplrLst, "");
    }
    
    public Window getShpTable() {
    	
    	
    	final SGTable unshpmTable1;
		Window win=new Window();
		VLayout shpLay = new VLayout();
		ToolStrip tool=new ToolStrip();
		tool.setMembersMargin(2);
		
		//SGPanel butForm = new SGPanel();
		//SGButtonItem searchBtn = new SGButtonItem(StaticRef.FETCH_BTN);
		//butForm.setItems(searchButton);
		shpLay.addMember(tool);
		final TextItem CUSTOMER_ID=new TextItem("CUSTOMER_ID");
		CUSTOMER_ID.setVisible(false);
		
		final ComboBoxItem CUSTOMER_NAME=new ComboBoxItem("CUSTOMER_NAME",Util.TI18N.CUSTOMER());
		CUSTOMER_NAME.setStartRow(true);
		CUSTOMER_NAME.setWidth(FormUtil.Width);
		CUSTOMER_NAME.setColSpan(2);
		CUSTOMER_NAME.setTitleAlign(Alignment.LEFT);
		CUSTOMER_NAME.setTitleOrientation(TitleOrientation.TOP);
		Util.initCustomerByQuery(CUSTOMER_NAME, CUSTOMER_ID);
		
		
		SGText SHPM_NO=new SGText("SHPM_NO",Util.TI18N.SHPM_NO());
		
		SGText CUSTOM_ODR_NO_NAME=new SGText("CUSTOM_ODR_NO",Util.TI18N.CUSTOM_ODR_NO());//客户单号
//		SGText ASSIGN_TIME_FROM = new SGText("ASSIGN_TIME_FROM",Util.TI18N.ASSIGN_TIME_FROM());
//		SGText ASSIGN_TIME_TO = new SGText("ASSIGN_TIME_TO","到");
//		Util.initDateTime(form, ASSIGN_TIME_FROM);
//		Util.initDateTime(form, ASSIGN_TIME_TO);
		
		SGText EXEC_ORG_ID = new SGText("EXEC_ORG_ID",Util.TI18N.EXEC_ORG_ID());
		EXEC_ORG_ID.setVisible(false);
	    //二级窗口 EXEC_ORG_ID 执行结构
		SGText EXEC_ORG_ID_NAME = new SGText("EXEC_ORG_ID_NAME",Util.TI18N.EXEC_ORG_ID());
		Util.initOrg(EXEC_ORG_ID_NAME, EXEC_ORG_ID, false, "50%", "50%");
		EXEC_ORG_ID.setValue(LoginCache.getLoginUser().getDEFAULT_ORG_ID());
		EXEC_ORG_ID_NAME.setValue(LoginCache.getLoginUser().getDEFAULT_ORG_ID_NAME());
		EXEC_ORG_ID_NAME.setWidth(FormUtil.Width);
		
		final TextItem LOAD_AREA_ID2 = new TextItem("LOAD_AREA_ID");
		LOAD_AREA_ID2.setWidth(FormUtil.Width);
		LOAD_AREA_ID2.setVisible(false);
		
		ComboBoxItem LOAD_AREA_NAME2=new ComboBoxItem("LOAD_AREA_NAME2","发货城市");//起点区域
		Util.initArea(LOAD_AREA_NAME2, LOAD_AREA_ID2);
		LOAD_AREA_NAME2.setTitleOrientation(TitleOrientation.TOP);
		LOAD_AREA_NAME2.setColSpan(2);
		LOAD_AREA_NAME2.setWidth(FormUtil.Width);
		
		final TextItem UNLOAD_AREA_ID2 = new TextItem("UNLOAD_AREA_ID2");
		UNLOAD_AREA_ID2.setVisible(false);
		ComboBoxItem UNLOAD_AREA_NAME2=new ComboBoxItem("UNLOAD_AREA_NAME2","收货城市");//
		Util.initArea(UNLOAD_AREA_NAME2, UNLOAD_AREA_ID2);
		UNLOAD_AREA_NAME2.setTitleOrientation(TitleOrientation.TOP);
		UNLOAD_AREA_NAME2.setColSpan(2);
		UNLOAD_AREA_NAME2.setWidth(FormUtil.Width);
		
		
		final TextItem LOAD_AREA_ID3 = new TextItem("LOAD_AREA_ID3");
		LOAD_AREA_ID3.setVisible(false);
		
		ComboBoxItem LOAD_AREA_NAME3=new ComboBoxItem("LOAD_AREA_NAME3",Util.TI18N.LOAD_AREA_NAME());//起点区域
		Util.initArea(LOAD_AREA_NAME3, LOAD_AREA_ID3);
		LOAD_AREA_NAME3.setTitleOrientation(TitleOrientation.TOP);
		LOAD_AREA_NAME3.setColSpan(2);
		LOAD_AREA_NAME3.setWidth(FormUtil.Width);
		
		final TextItem UNLOAD_AREA_ID3 = new TextItem("UNLOAD_AREA_ID3");
		UNLOAD_AREA_ID3.setVisible(false);
		ComboBoxItem UNLOAD_AREA_NAME3=new ComboBoxItem("UNLOAD_AREA_NAME3",Util.TI18N.UNLOAD_AREA_NAME());//
		Util.initArea(UNLOAD_AREA_NAME3, UNLOAD_AREA_ID3);
		UNLOAD_AREA_NAME3.setTitleOrientation(TitleOrientation.TOP);
		UNLOAD_AREA_NAME3.setColSpan(2);
		UNLOAD_AREA_NAME3.setWidth(FormUtil.Width);
		
		SGCombo TRANS_SRVC_ID = new SGCombo("TRANS_SRVC_ID", Util.TI18N.TRANS_SRVC_ID());
		TRANS_SRVC_ID.setTitle(Util.TI18N.TRANS_SRVC_ID());
		Util.initTrsService(TRANS_SRVC_ID, "");

		SGCombo SUPLR_ID =new SGCombo("SUPLR_ID", Util.TI18N.SUPLR_NAME());//供应商
		Util.initSupplier(SUPLR_ID, "");
		
		SGCombo BIZ_TYP = new SGCombo("BIZ_TYP", Util.TI18N.BIZ_TYP());	//业务类型
		Util.initCodesComboValue(BIZ_TYP, "BIZ_TYP");
		
		SGText LOAD_ID = new SGText("LOAD_CODE", Util.TI18N.LOAD_NAME_ID());//收货方代码
		
		SGText LOAD_NAME = new SGText("LOAD_NAME", Util.TI18N.LOAD_NAME());//发货方
		
		SGText UNLOAD_NAME = new SGText("UNLOAD_NAME", Util.TI18N.UNLOAD_NAME());//收货方
//		SGDateTime ORD_ADDTIME_FROM=new SGDateTime("ADDTIME_FROM",Util.TI18N.ORD_ADDTIME_FROM());
//		SGDateTime ORD_ADDTIME_TO=new SGDateTime("ADDTIME_TO","到");//创建时间
		
		SGText UNLOAD_ID = new SGText("UNLOAD_CODE", Util.TI18N.UNLOAD_NAME_ID());//收货方代码

		SGCombo STATUS =new SGCombo("SHPM_STATUS", Util.TI18N.SHPM_STSTUS());//
		Util.initCodesComboValue(STATUS, "SHPM_STAT");
		STATUS.setVisible(false);
		
		//SGCombo ASSIGN_STAT =new SGCombo("ASSIGN_STAT_NAME", Util.TI18N.ASSIGN_STAT());//
		//Util.initStatus(ASSIGN_STAT, "ASSIGN_STAT", "");
		SGCombo EXEC_STAT = new SGCombo("EXEC_STAT", Util.TI18N.STATUS());//执行状态
		//Util.initCodesComboValue(EXEC_STAT,"EXEC_STAT",StaticRef.NORMAL);
		Util.initCodesComboValue(EXEC_STAT,"EXEC_STAT","");
		
		SGText Queue = new SGText("QUEUE","QUEUE");
		Queue.setVisible(false);
		Queue.setValue("Y");
		
		//SGCombo LOAD_PRINT = new SGCombo("PRINT_STATUS","提货单打印");
		//Util.initCodesComboValue(LOAD_PRINT,"PRINT_STATUS");
		
		SGCombo ROUTE_ID = new SGCombo("ROUTE_ID", Util.TI18N.ROUTE_NAME());	//业务类型
		Util.initComboValue(ROUTE_ID, "BAS_ROUTE_HEAD", "ID", "ROUTE_NAME",
				" where EXEC_ORG_ID in (select id from bas_org where id='"+LoginCache.getLoginUser().getDEFAULT_ORG_ID()+"' " +
						"or org_index like '%,"+LoginCache.getLoginUser().getDEFAULT_ORG_ID()+",%')", 
				" order by show_seq asc");
		
		SGCombo TRANS_COND = new SGCombo("REFENENCE4",Util.TI18N.TRANS_COND());
        Util.initCodesComboValue(TRANS_COND, "TRANS_COND");
       
        
		SGCheck C_ORG_FLAG = new SGCheck("C_ORG_FLAG", Util.TI18N.C_ORG_FLAG());	
		C_ORG_FLAG.setColSpan(2);
		C_ORG_FLAG.setValue(true);
		
		SGText ODR_TIME_FROM = new SGText("ODR_TIME_FROM", Util.TI18N.ODR_TIME_FROM()); //璁㈠崟鏃堕棿
		SGText ODR_TIME_TO = new SGText("ODR_TIME_TO", "到");
		
		final SGPanel form=new SGPanel();
		form.setNumCols(12);
		Util.initDateTime(form,ODR_TIME_FROM);
		Util.initDateTime(form,ODR_TIME_TO);
		ODR_TIME_FROM.setWidth(FormUtil.Width);
		ODR_TIME_TO.setWidth(FormUtil.Width);
		
		SGText ODR_NO = new SGText("ODR_NO", Util.TI18N.ODR_NO());
		SGText REFENENCE1=new SGText("REFENENCE1",Util.TI18N.REFENENCE1());
		
		SGDateTime POD_TIME5 = new SGDateTime("PRE_UNLOAD_TIME_FROM", "计划派送时间");
		POD_TIME5.setWidth(FormUtil.Width);
		SGDateTime POD_TIME6 = new SGDateTime("PRE_UNLOAD_TIME_TO", "到");
		POD_TIME6.setWidth(FormUtil.Width);
		
		SGText UDF6 = new SGText("UDF6",Util.TI18N.SHPM_UDF6());
		UDF6.setValue("N");
		UDF6.setVisible(false);
		
		SGText ADD_TIME_FROM = new SGText("ADDTIME_FROM", Util.TI18N.ORD_ADDTIME_FROM()); //
		SGText ADD_TIME_TO = new SGText("ADDTIME_TO", "到");
		Util.initDateTime(form,ADD_TIME_FROM);
		Util.initDateTime(form,ADD_TIME_TO);
		ADD_TIME_FROM.setWidth(FormUtil.Width);
		ADD_TIME_TO.setWidth(FormUtil.Width);
		
		SGButtonItem searchButton1=new SGButtonItem(StaticRef.FETCH_BTN);
		
		
		form.setItems(CUSTOMER_ID,CUSTOMER_NAME,SHPM_NO,CUSTOM_ODR_NO_NAME,EXEC_ORG_ID,EXEC_ORG_ID_NAME,LOAD_AREA_NAME2,LOAD_AREA_ID2,
				UNLOAD_AREA_NAME2,UNLOAD_AREA_ID2,TRANS_SRVC_ID,SUPLR_ID,
				LOAD_NAME,UNLOAD_NAME,LOAD_ID, UNLOAD_ID,
				STATUS,ODR_TIME_FROM,ODR_TIME_TO,EXEC_STAT,TRANS_COND,BIZ_TYP,ROUTE_ID,LOAD_AREA_NAME3,LOAD_AREA_ID3,
				UNLOAD_AREA_NAME3,UNLOAD_AREA_ID3, Queue, ODR_NO,REFENENCE1 ,POD_TIME5, POD_TIME6, ADD_TIME_FROM, ADD_TIME_TO, UDF6, C_ORG_FLAG,searchButton1);
		//return form;
		shpLay.addMember(form);
		
		unshpmTable1=new SGTable(unshpmDS, "100%", "100%", false, true, false);
		unshpmTable1.setSelectionAppearance(SelectionAppearance.CHECKBOX);
		unshpmTable1.setCanEdit(false); 
		createUnshpmField1(unshpmTable1);
	
		final SectionStack shpSectionStack =new SectionStack();	  //unshpmTable分页的布局	
		SectionStackSection shpsection=new SectionStackSection(Util.TI18N.UNDISPATCHORDER());
		shpsection.setItems(unshpmTable1);
		shpsection.setExpanded(true);
		DynamicForm form1=new DynamicForm();
		DynamicForm form2=new SGPage(unshpmTable1, true).initPageBtn();
		TabSet topTabSet = new TabSet();
		Tab shpmTab = new Tab(""); 
		shpmTab.setPane(shpLay);
		topTabSet.addTab(shpmTab);
		topTabSet.setWidth("100%");
		//topTabSet.addTab(tab)
		TabSet downTabSet = new TabSet();
		shpsection.setControls(subView.createTopBtn(topTabSet, downTabSet), form1, form2);
		shpSectionStack.addSection(shpsection);


       
		IButton shpmBut = createUDFBtn(Util.BI18N.CREATELOAD(), StaticRef.ICON_SAVE, TrsPrivRef.Vehicle_P1_02);
		shpmBut.addClickHandler(new MakeLoadNoAction(unshpmTable1, loadTable, getView()));
		
        searchButton1.addClickHandler(
		    new com.smartgwt.client.widgets.form.fields.events.ClickHandler() {
			
			@Override
			public void onClick(
					com.smartgwt.client.widgets.form.fields.events.ClickEvent event) {
				doFilter1(unshpmTable1,form);
				
			}
		});
		
		tool.setMembers(shpmBut);
		tool.setAlign(Alignment.RIGHT);
		tool.setWidth("100%");
		//shpLay.addMember(unshpmTable1);
		shpLay.addMember(shpSectionStack);		
		win.addItem(shpLay);
		win.setTitle("待调作业单");
		win.setWidth("80%");
		win.setHeight("90%");
		win.setTop("5%");
		win.setLeft("10%");
	//	doFilter1(unshpmTable1,form);
		return win;
	}
    private void doFilter1(SGTable tab,DynamicForm form){
		Criteria criteria = form.getValuesAsCriteria();
		if(criteria == null) {
			criteria = new Criteria();
		}
		criteria.addCriteria("OP_FLAG","M");
		criteria.addCriteria("ENABLE_FLAG","Y");
		tab.invalidateCache();
		tab.fetchData(criteria);  
   }
    
}
