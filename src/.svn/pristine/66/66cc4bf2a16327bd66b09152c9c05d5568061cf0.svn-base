package com.rd.client.view.warning;

import com.rd.client.PanelFactory;
import com.rd.client.common.action.ExportAction;
import com.rd.client.common.obj.LoginCache;
import com.rd.client.common.util.BasPrivRef;
import com.rd.client.common.util.StaticRef;
import com.rd.client.common.util.Util;
import com.rd.client.common.widgets.SGCombo;
import com.rd.client.common.widgets.SGForm;
import com.rd.client.common.widgets.SGPage;
import com.rd.client.common.widgets.SGPanel;
import com.rd.client.common.widgets.SGTable;
import com.rd.client.common.widgets.SGText;
import com.rd.client.ds.base.HaulingCapacityManagerDS;
import com.rd.client.reflection.ClassForNameAble;
import com.rd.client.win.SearchWin;
import com.smartgwt.client.data.DSCallback;
import com.smartgwt.client.data.DSRequest;
import com.smartgwt.client.data.DSResponse;
import com.smartgwt.client.data.DataSource;
import com.smartgwt.client.types.Alignment;
import com.smartgwt.client.widgets.Canvas;
import com.smartgwt.client.widgets.IButton;
import com.smartgwt.client.widgets.events.ClickEvent;
import com.smartgwt.client.widgets.events.ClickHandler;
import com.smartgwt.client.widgets.form.DynamicForm;
import com.smartgwt.client.widgets.grid.ListGridField;
import com.smartgwt.client.widgets.layout.HStack;
import com.smartgwt.client.widgets.layout.SectionStack;
import com.smartgwt.client.widgets.layout.SectionStackSection;
import com.smartgwt.client.widgets.layout.VLayout;
import com.smartgwt.client.widgets.tab.Tab;
import com.smartgwt.client.widgets.tab.TabSet;
import com.smartgwt.client.widgets.tab.events.TabSelectedEvent;
import com.smartgwt.client.widgets.tab.events.TabSelectedHandler;
import com.smartgwt.client.widgets.toolbar.ToolStrip;

/**
 * 
 * 运输管理--保险到期提醒
 * @author wangjun
 *
 */
@ClassForNameAble
public class InsurWarnManagerView extends SGForm implements PanelFactory {

	private DataSource loadDS;
	private DataSource DS;
	private DataSource podDS;
	private SGTable loadtable;
	private SGTable podtable;
	//private Window searchWin;  --yuanlei 2011-2-16
	//private SGPanel searchForm;  yuanlei 2011-2-15
	private SectionStack loadsection;

	private SectionStack podsection;
	private DynamicForm pageForm1;
	private DynamicForm pageForm3;
	private int tabNum = 4;
	public SGTable table;

	private com.smartgwt.client.widgets.Window searchWin;
	private SGPanel searchForm;
	
	/**
	 * 	应发未发  PRE_lOAD_EXCEL
   	 *	应到未到  PRE_UNLOAD_EXCEL
  	 *	应回未回 PRE_POD_EXCEL
	 */
	
	/*public InsurWarnManagerView(String id) {
		super(id);
	}*/

	@Override
	public Canvas getViewPanel() {
		
		podDS = HaulingCapacityManagerDS.getInstall("V_INS_REMIND");
		loadDS = HaulingCapacityManagerDS.getInstall("V_INS_REMIND");
		
		// 主布局
		HStack stack = new HStack();// 设置详细信息布局
		stack.setWidth100();
		stack.setHeight100();
		
		loadtable= new SGTable(loadDS, "100%", "100%");
		podtable= new SGTable(podDS, "100%", "100%");
		
		loadtable.setShowFilterEditor(false);
		podtable.setShowFilterEditor(false);
		
		TabSet tabset=new TabSet();
		tabset.setWidth("100%");
		tabset.setHeight("100%");
		tabset.setMargin(0);
		
		//创建Section
		loadsection = new SectionStack();
		loadsection.setWidth("100%");
		loadsection.setHeight("100%");
		
		createloadFields(loadtable);
		Tab tab1 = new Tab("保险逾期提醒");//页签名称1：应发未发
		tab1.setPane(loadsection);
		tabset.addTab(tab1);
		
		final SectionStackSection listItem = new SectionStackSection();//
	    listItem.setItems(loadtable);
	    listItem.setExpanded(true);
	    pageForm1 = new SGPage(loadtable, true).initPageBtn();
	    listItem.setControls(pageForm1);
	    loadsection.addSection(listItem);
	    
	    
	    /** 商业保险逾期提醒 已经删除 **/
	    
	    podsection = new SectionStack();
		podsection.setWidth("100%");
		podsection.setHeight("100%");
		
		createpodFields(podtable);
		Tab tab3 = new Tab("年审逾期提醒");//页签名称1：应回未回
		tab3.setPane(podsection);
		tabset.addTab(tab3);
		
		final SectionStackSection podlistItem = new SectionStackSection();//
		podlistItem.setItems(podtable);
		podlistItem.setExpanded(true);
		pageForm3 = new SGPage(podtable, true).initPageBtn();
		podlistItem.setControls(pageForm3);
	    podsection.addSection(podlistItem);
		
	    DS = HaulingCapacityManagerDS.getInstall("V_BAS_VEHICLE", "BAS_VEHICLE");
	    
	    privObj = LoginCache.getUserPrivilege().get(getFUNCID());
		VLayout main = new VLayout();//定义全局布局
		main.setWidth100();
		main.setHeight100();
		
		ToolStrip toolStrip = new ToolStrip();//按钮布局
		toolStrip.setAlign(Alignment.RIGHT);
		
	
		//创建按钮布局
		createBtnWidget(toolStrip);
		
		main.addMember(toolStrip);
		main.addMember(tabset);
		

        
		tabset.addTabSelectedHandler(new TabSelectedHandler() {
			
			@Override
			public void onTabSelected(TabSelectedEvent event) {
				tabChanged(event.getTabNum());
			}
		});
		
		initVerify(); 
		return main;
		
	}
	private void tabChanged(int num){
		
		if(num != tabNum){
			if(num == 0){
				loadtable.filterData(findValues,new DSCallback() {

					@Override
					public void execute(DSResponse response, Object rawData,
							DSRequest request) {
							pageForm1.getField("CUR_PAGE").setValue("1");
							LoginCache.setPageResult(loadtable, pageForm1.getField("TOTAL_COUNT"), pageForm1.getField("SUM_PAGE"));
						}
						
					}
					
				);
			}else{
				podtable.filterData(findValues,new DSCallback() {

					@Override
					public void execute(DSResponse response, Object rawData,
							DSRequest request) {
							pageForm3.getField("CUR_PAGE").setValue("1");
							LoginCache.setPageResult(podtable, pageForm3.getField("TOTAL_COUNT"), pageForm3.getField("SUM_PAGE"));
						}
						
					} 	
					
				);
			}
			tabNum = num;
		}
	}
	private void createloadFields(SGTable loadtable) {
		
		loadtable.setShowRowNumbers(true);
		ListGridField PLATE_NO = new ListGridField("PLATE_NO", Util.TI18N.PLATE_NO(), 75);
		ListGridField VEHICLE_NO = new ListGridField("VEHICLE_NO", Util.TI18N.VEHICLE_NO(), 75);
		ListGridField VEHICLE_STAT_NAME = new ListGridField("VEHICLE_STAT_NAME",Util.TI18N.VEHICLE_STAT(), 75);
		ListGridField VECHILE_TYP_ID = new ListGridField("VEHICLE_TYP_ID_NAME",Util.TI18N.VECHILE_TYP_ID(), 75);
		ListGridField VEHICLE_ATTR = new ListGridField("VEHICLE_ATTR_NAME",Util.TI18N.VEHICLE_ATTR(), 75);
		ListGridField SUPLR_ID = new ListGridField("SUPLR_ID_NAME",Util.TI18N.SUPLR_ID(), 75);
		ListGridField DRIVER1 = new ListGridField("DRIVER1_NAME", Util.TI18N.DRIVER1(), 65);
		ListGridField MOBILE = new ListGridField("MOBILE1", Util.TI18N.MOBILE(),70);
		ListGridField LOCATION = new ListGridField("LOCATION", Util.TI18N.LOCATION(), 70);
		ListGridField MAX_WEIGHT = new ListGridField("MAX_WEIGHT", Util.TI18N.MAX_WEIGHT(), 70);
		MAX_WEIGHT.setShowHover(true);
		ListGridField MAX_VOLUME = new ListGridField("MAX_VOLUME", Util.TI18N.MAX_VOLUME(), 75);
		ListGridField INS_TO = new ListGridField("INS_TO",Util.TI18N.INS_EXP_DT(),110);
		ListGridField REMAIN_DAYS = new ListGridField("REMAIN_DAYS","剩余天数",75);
		loadtable.setFields(PLATE_NO, VEHICLE_NO, VECHILE_TYP_ID, SUPLR_ID,VEHICLE_STAT_NAME, 
				VEHICLE_ATTR, DRIVER1, MOBILE, LOCATION, MAX_WEIGHT,
				MAX_VOLUME,INS_TO,REMAIN_DAYS);
		
	}

	private void createpodFields(SGTable podtable) {
		podtable.setShowRowNumbers(true);
		ListGridField PLATE_NO = new ListGridField("PLATE_NO", Util.TI18N.PLATE_NO(), 75);
		ListGridField VEHICLE_NO = new ListGridField("VEHICLE_NO", Util.TI18N.VEHICLE_NO(), 75);
		ListGridField VEHICLE_STAT_NAME = new ListGridField("VEHICLE_STAT_NAME",Util.TI18N.VEHICLE_STAT(), 75);
		ListGridField VECHILE_TYP_ID = new ListGridField("VEHICLE_TYP_ID_NAME",Util.TI18N.VECHILE_TYP_ID(), 75);
		ListGridField VEHICLE_ATTR = new ListGridField("VEHICLE_ATTR_NAME",Util.TI18N.VEHICLE_ATTR(), 75);
		ListGridField SUPLR_ID = new ListGridField("SUPLR_ID_NAME",Util.TI18N.SUPLR_ID(), 75);
		ListGridField DRIVER1 = new ListGridField("DRIVER1_NAME", Util.TI18N.DRIVER1(), 65);
		ListGridField MOBILE = new ListGridField("MOBILE1", Util.TI18N.MOBILE(),70);
		ListGridField LOCATION = new ListGridField("LOCATION", Util.TI18N.LOCATION(), 70);
		ListGridField MAX_WEIGHT = new ListGridField("MAX_WEIGHT", Util.TI18N.MAX_WEIGHT(), 70);
		MAX_WEIGHT.setShowHover(true);
		ListGridField MAX_VOLUME = new ListGridField("MAX_VOLUME", Util.TI18N.MAX_VOLUME(), 75);
		
		ListGridField VEH_LOCK_REASON = new ListGridField("VEH_LOCK_REASON",Util.TI18N.VEH_LOCK_REASON());
		ListGridField REASON = new ListGridField("REASON",Util.TI18N.REASON());		
		
		podtable.setFields(PLATE_NO, VEHICLE_NO, VECHILE_TYP_ID, SUPLR_ID,VEHICLE_STAT_NAME, 
				VEHICLE_ATTR, DRIVER1, MOBILE, LOCATION, MAX_WEIGHT,
				MAX_VOLUME,VEH_LOCK_REASON,REASON);
	}
	
	
	
	@Override
	public void createBtnWidget(ToolStrip toolStrip) {
		
		toolStrip.setWidth("100%");
		toolStrip.setHeight("20");
		toolStrip.setPadding(2);
		toolStrip.setSeparatorSize(12);
		toolStrip.addSeparator();
		//查询: 创建按钮 绑定事件
		IButton searchButton=createBtn(StaticRef.FETCH_BTN);
		searchButton.addClickHandler(new ClickHandler() {
			
			@Override
			public void onClick(ClickEvent event) {
				// TODO Auto-generated method stub
			   if(searchWin==null){
				   searchForm=new SGPanel();
					searchWin = new SearchWin(loadDS, createSerchForm(searchForm),
							loadsection.getSection(0)).getViewPanel();
				}else{
					searchWin.show();
				}
				
			}
		});
		
		//导出
		 IButton expButton = createBtn(StaticRef.EXPORT_BTN,BasPrivRef.PACK_P0_05);
	     expButton.addClickHandler(new ExportAction(table,"ADDTIME"));
		
        toolStrip.setMembersMargin(2);
        toolStrip.setMembers(searchButton,expButton);
        
		
	}
	
	
	//查询窗口（二级窗口）
	public DynamicForm createSerchForm(DynamicForm form) {
		// TODO Auto-generated method stub
		form.setDataSource(DS);
		form.setAutoFetchData(false);
		form.setWidth100();
		form.setCellPadding(2);
		//1.
		SGText PLATE_NO = new SGText("PLATE_NO", "车牌号");
	
		//2.
		SGCombo VEHICLE_ATTR_NAME = new SGCombo("VECHILE_TYP_ID", Util.TI18N
				.VEHICLE_ATTR(), true);
		Util.initComboValue(VEHICLE_ATTR_NAME, "V_INS_REMIND", "PlATE_NO",
				"VEHICLE_ATTR_NAME");
		//3.
		SGText WITHIN_FEW_DAYS  = new SGText("WITHIN_FEW_DAYS", "几天以内");
		
		form.setItems(PLATE_NO, VEHICLE_ATTR_NAME,WITHIN_FEW_DAYS);
		return form;
	}
	
	

	
	
	@Override
	public void createForm(DynamicForm form) {
		
	}

	@Override
	public void initVerify() {
	}

	@Override
	public void onDestroy() {
		// --yuanlei 2011-2-16
		/*if (searchWin != null) {
			searchWin.destroy();
		}*/
		
	}

	@Override
	public Canvas createCanvas(String id,TabSet tabSet) {
		InsurWarnManagerView view = new InsurWarnManagerView();
		view.setFUNCID(id);
		view.addMember(view.getViewPanel());
		return view;
	}

	@Override
	public String getCanvasID() {
		// TODO Auto-generated method stub
		return getID();
	}

}
