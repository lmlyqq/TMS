package com.rd.client.action.tms.shpmreceipt;

import com.rd.client.common.util.ColorUtil;
import com.rd.client.common.util.MSGUtil;
import com.rd.client.common.util.StaticRef;
import com.rd.client.common.util.Util;
import com.rd.client.common.widgets.SGPanel;
import com.rd.client.common.widgets.SGTable;
import com.smartgwt.client.types.Alignment;
import com.smartgwt.client.types.ContentsType;
import com.smartgwt.client.types.Encoding;
import com.smartgwt.client.types.FormMethod;
import com.smartgwt.client.types.TitleOrientation;
import com.smartgwt.client.widgets.HTMLPane;
import com.smartgwt.client.widgets.Window;
import com.smartgwt.client.widgets.form.DynamicForm;
import com.smartgwt.client.widgets.form.fields.ButtonItem;
import com.smartgwt.client.widgets.form.fields.UploadItem;
import com.smartgwt.client.widgets.form.fields.events.ClickEvent;
import com.smartgwt.client.widgets.form.fields.events.ClickHandler;
import com.smartgwt.client.widgets.layout.SectionStackSection;
import com.smartgwt.client.widgets.layout.VLayout;

public class UploadImageAction extends Window{
	private int width = 300;
	private int height = 200;
	public SectionStackSection section;
	public DynamicForm mainSearch;
	private SGPanel form;
	public Window window ;
	public SGTable orderTable;
	private DynamicForm  uploadForm;
//	private TmsOrdManageView view = new TmsOrdManageView();
	private UploadItem imageItem;
	private String unique_ID;
	private String type;

	public String odrNo;
	
	public UploadImageAction(SGTable orderTable){
		this.orderTable = orderTable;
	}
	public UploadImageAction(SGTable orderTable,String unique_ID){
		this.orderTable = orderTable;
	    this.unique_ID = unique_ID;
	}
	
	public UploadImageAction(SGTable orderTable,String unique_ID,String type){
		this.orderTable = orderTable;
	    this.unique_ID = unique_ID;
	    this.type = type;
	    
	}
	
	
	public Window getViewPanel() {
		    form = new SGPanel();
			form.setHeight(height/2);
			form.setWidth(width-20);
			form.setNumCols(8);
			form.setPadding(5);
			form.setTitleWidth(75);
			form.setAlign(Alignment.CENTER);
			form.setHeight100();
			createForm(form);
			
			VLayout vLay = new VLayout();
			vLay.setWidth100();
			vLay.setBackgroundColor(ColorUtil.BG_COLOR);
			
			uploadForm = new DynamicForm();
			uploadForm.setNumCols(2);
			uploadForm.setAction("uploadServlet");
			uploadForm.setEncoding(Encoding.MULTIPART);
			uploadForm.setMethod(FormMethod.POST);
			uploadForm.setTarget("foo");
			
			HTMLPane htmlPane = new HTMLPane();
			htmlPane.setContentsType(ContentsType.PAGE);
			htmlPane
					.setContents("<iframe name='foo' style='position:absolute;width:0;height:0;border:0'></iframe>");
			htmlPane.setWidth("1");
			htmlPane.setHeight("1");
			
			imageItem = new UploadItem("image", "图片  ");
//			TextItem notes = new TextItem("NOTES", "描述");
			imageItem.setWidth(150);
			imageItem.setColSpan(4);
//			imageItem.getTitle();
//			imageItem.setShowPickerIcon(true);
//			imageItem.setShowTitle(false);
//			imageItem.setShowHintInField(true);
//			imageItem.setTextBoxStyle(textBoxStyle)
			imageItem.setTitleOrientation(TitleOrientation.TOP);
			imageItem.setAlign(Alignment.LEFT);
			uploadForm.setItems(imageItem);
			uploadForm.setAlign(Alignment.LEFT);
			
			
			VLayout lay1 = new VLayout();
			lay1.setWidth100();
			lay1.setHeight100();
			lay1.setMembers(form);
			lay1.setMembers(uploadForm);

			 window = new Window();
			 window.setTitle("上传");
			 window.setLeft("40%");
			 window.setTop("50%");
			 window.setWidth(width);  
			 window.setHeight(height); 
			 window.setAlign(Alignment.CENTER);
			 window.setCanDragReposition(true);  
			 window.setCanDragResize(true);
			 window.addItem(lay1);
			 window.addItem(mainSearch);
			 return window;
	}
	public void createForm(DynamicForm dynamicForm){
		
		
		
		ButtonItem saveItem = new ButtonItem("save", "上传");
		saveItem.setAutoFit(true);
		saveItem.setIcon(StaticRef.ICON_UPLOAD);
		saveItem.setColSpan(4);
		saveItem.setStartRow(false);
		saveItem.setEndRow(false);
		saveItem.setAutoFit(true);
		saveItem.addClickHandler(new ClickHandler() {
		  @Override
		  public void onClick(ClickEvent event) {
			if(unique_ID != null){
				String str = type+unique_ID;
				if(str.indexOf("#") > 0){
					str = str.replace("#", "%23");
				}
				uploadForm.setAction("uploadServlet?unique_ID="+str);
				if(imageItem.getValue() != null){
					String iffn = imageItem.getValue().toString().toLowerCase();
					if(iffn.endsWith(".jpg") || 
							iffn.endsWith(".jpeg") || 
							iffn.endsWith(".gif") ||
							iffn.endsWith(".png")){
							uploadForm.submitForm();
							MSGUtil.sayInfo("上传成功.");
							uploadForm.destroy();//必需要destory该form，否则会导致重新开启一个新的页面
							window.destroy();
//						}
					}else {
						MSGUtil.sayWarning("只能上传图片.");
					}
				} else {
					
					MSGUtil.sayWarning("请选择图片.");
				}
			} else {
				MSGUtil.sayWarning("请选择影像对应的回单号!");
			}
		  }
	  });
		ButtonItem clearItem = new ButtonItem(Util.BI18N.CLEAR());
		clearItem.setIcon(StaticRef.ICON_CANCEL);
		clearItem.setColSpan(1);
		clearItem.setAutoFit(true);
		clearItem.setStartRow(false);
		clearItem.setEndRow(false);
		clearItem.addClickHandler(new ClickHandler() {
			@Override
			public void onClick(ClickEvent event) {
				uploadForm.clearValues();
			}
		});
		
		mainSearch = new DynamicForm();
		mainSearch.setCellPadding(5);
		mainSearch.setNumCols(5);
		mainSearch.setItems(saveItem,clearItem);
		mainSearch.setBackgroundColor(ColorUtil.BG_COLOR);
	}
//	public static native boolean compareFile() /*-{
//		var FileMaxSize = 50;//限制上传的文件大小，单位(k)
//		var  Sys = {};
//           
//        if(isFirefox=navigator.userAgent.indexOf("Firefox")>0){   
//            Sys.firefox=true;
//        } 
//		unction checkFileChange(obj) {
//			obj
//            var filesize = 0;
//            if(Sys.firefox){
//                filesize = obj.files[0].fileSize;
//            }
//            alert(filesize);
//        }
//	if(img.fileSize>FileMaxSize){
////	      alert("The file size exceeds "+FileMaxSize+"K，please choose a smaller one!");
////	      document.personRight.imgfile1.focus();
//	      return false;
//	}else{
//		return true;
//	}
//	}-*/;


	
}
